<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>:floppy_disk:客户端本地存储技术 - shesl's blog</title><meta name=Description content="佘崧林同学的碎碎念博客"><meta property="og:title" content=":floppy_disk:客户端本地存储技术"><meta property="og:description" content="在实习过程中，在字节跳动内部分享上学习的东西 客户端本地存储主要有以下的几个作用： 作为网络 IO 的缓存：缓存图片、缓存接口的 Response； 保存"><meta property="og:type" content="article"><meta property="og:url" content="http://shesl-meow.github.io/posts/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/"><meta property="og:image" content="http://shesl-meow.github.io/avatar.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-12T18:50:46+08:00"><meta property="article:modified_time" content="2019-11-12T18:50:46+08:00"><meta property="og:site_name" content="shesl's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://shesl-meow.github.io/avatar.png"><meta name=twitter:title content=":floppy_disk:客户端本地存储技术"><meta name=twitter:description content="在实习过程中，在字节跳动内部分享上学习的东西 客户端本地存储主要有以下的几个作用： 作为网络 IO 的缓存：缓存图片、缓存接口的 Response； 保存"><meta name=application-name content="shesl's blog"><meta name=apple-mobile-web-app-title content="shesl's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://shesl-meow.github.io/posts/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/><link rel=prev href=http://shesl-meow.github.io/posts/c++%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E6%A2%B3%E7%90%86/><link rel=next href=http://shesl-meow.github.io/posts/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93-mongodb-%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/><link rel=stylesheet href=/css/style.min.1310433f6cdab9b292f4d93b71eeb4dcd4a0fc3770f6d90e2d21faa5387856c5.css integrity="sha256-ExBDP2zaubKS9Nk7ce603NSg/Ddw9tkOLSH6pTh4VsU="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":":floppy_disk:客户端本地存储技术","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/shesl-meow.github.io\/posts\/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8\/"},"genre":"posts","keywords":"客户端, Database","wordcount":5250,"url":"http:\/\/shesl-meow.github.io\/posts\/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8\/","datePublished":"2019-11-12T18:50:46+08:00","dateModified":"2019-11-12T18:50:46+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"佘崧林"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="shesl's blog">shesl-meow</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>博客
</a><a class=menu-item href=/tags/>标签
</a><a class=menu-item href=/categories/>分类
</a><a class=menu-item href=/note/>笔记</a><div class=dropdown><a class="menu-item menu-more dropbtn" title href=javascript:void(0);>游戏</a><div class="menu-more-content dropdown-content"><a href=/games/2048/ title><i class='fa-solid fa-chess-board'></i> 2048</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="shesl's blog">shesl-meow</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>博客
</a><a class=menu-item href=/tags/>标签
</a><a class=menu-item href=/categories/>分类
</a><a class=menu-item href=/note/>笔记</a><div class=dropdown><a class="menu-item menu-more dropbtn" title href=javascript:void(0);>游戏</a><div class="menu-more-content dropdown-content"><a href=/games/2048/ title><i class='fa-solid fa-chess-board'></i> 2048</a></div></div><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">💾客户端本地存储技术</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://shesl-meow.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>佘崧林</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-11-12>2019-11-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 5250 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 11 分钟&nbsp;<span id=/posts/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/ class=leancloud_visitors data-flag-title=:floppy_disk:客户端本地存储技术>
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#plist>Plist</a></li><li><a href=#nsuserdefault>NSUserDefault</a></li><li><a href=#mmkv>MMKV</a><ul><li><a href=#mmap-技术>mmap 技术</a></li><li><a href=#mmkv-技术>MMKV 技术</a></li></ul></li><li><a href=#sqlite>SQLite</a><ul><li><a href=#delete-模式>DELETE 模式</a></li><li><a href=#wal-模式>WAL 模式</a></li></ul></li><li><a href=#yycache>YYCache</a></li><li><a href=#wcdb>WCDB</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>在实习过程中，在字节跳动内部分享上学习的东西</p></blockquote><p>客户端本地存储主要有以下的几个作用：</p><ol><li>作为网络 IO 的缓存：缓存图片、缓存接口的 Response；</li><li>保存配置或者数据：配置信息、状态信息、日志信息、Crash 信息等；</li><li>作为内存的 Backing Store：暂存大文件、征用扩展内存；</li></ol><p>方法论：如何分析各种存储方案，主要考虑以下几个特性：</p><ol><li><strong>读写性能</strong>：平均读写性能、最坏读写性能；</li><li><strong>并发性能</strong>：是否线程安全、读写操作互相并发的能力；</li><li><strong>数据完整性</strong>：数据损失或丢失的概率；</li><li><strong>空间性能</strong>：存储相同的数据，需要的磁盘与内存空间；</li></ol><h2 id=plist>Plist</h2><p>plist 是一种 xml 格式，是 iOS 中最常用的配置存储数据格式，下面是一个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;plist</span> <span class=na>version=</span><span class=s>&#34;1.0&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dict&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;key&gt;</span>quiz<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;dict&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;key&gt;</span>question<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;array&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;dict&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;key&gt;</span>text<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;string&gt;</span>What does &#39;API&#39; stand for?<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;key&gt;</span>answer<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;string&gt;</span>API stands for Application Programming Interface.<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;/dict&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;dict&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;key&gt;</span>text<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;string&gt;</span>What&#39;s so good about pragmatic REST?<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;key&gt;</span>answer<span class=nt>&lt;/key&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;string&gt;</span>It&#39;s focused on the api consumer, so it makes it easier for developers to contribute to your app library!<span class=nt>&lt;/string&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;/dict&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;/array&gt;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/dict&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dict&gt;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>读写性能都是 O(n)，必须全部从磁盘中读出写入；</li><li>数据完整性：每次都要全量读写。断电等不可抗力发生时，数据损失发生概率更大；</li><li>磁盘空间复杂度 O(n)，内存空间复杂度 0；</li><li>并发性能需要自己实现；</li></ul><p>适用场景：</p><ul><li>Plist 不适合存储过多数据，这样会造成比较严重的读/写延时。同时也会增加 Plist 损坏的概率，导致数据丢失。</li><li>Plist 适合与简单少量配置存储的场景，这种情况下，性能可以接受，操作的实现也足够简洁。</li></ul><h2 id=nsuserdefault>NSUserDefault</h2><p><code>NSUserDefault</code> 是常用的客户端 K-V 存储方案，其底层使用 Plist 文件存储，不同于直接操作 Plist 文件读写数据：</p><ul><li><code>NSUserDefault</code> 内部设置了<strong>内存缓存</strong>，大大提升了读性能；</li><li>通过异步跨线程的延时同步机制，<code>NSUserDefault</code> 会在写入事件发生后的一段时间批量的处理写入操作，提升写入性能。</li></ul><p>性能分析：</p><ul><li>读操作一般是直接读取内存，平均时间复杂度为 0；最坏读性能发生初始化之前，时间复杂度 O(n)；</li><li>如果平均 x 次写入进行一次全量写回，平均时间复杂度 O(n/x)；最坏就是连续全量写回 O(n)；</li><li>数据完整性：<code>NSUserDefault</code> 的异步延时同步机制很有可能导致数据在极端情况下无法触发，但是相对于 Plist，其有更少的回写次数。所以其数据损坏的可能性比 Plist 小，但是数据丢失的概率比 Plist 大。</li><li>空间性能：除了内存开销，与 plist 一致；</li><li>并发性能：<code>NSUserDefault</code> 是线程安全的，但是不支持并发；</li></ul><p><code>NSUserDefault</code> 是 Plist 的优化：</p><ul><li>有更好的读写性能、以及更友好简单的操作接口；</li><li>但是它需要额外的内存开销，而且写性能依然比较差，经常会触发全量回写，没有质的提升，依然只推荐存储较少的数据；</li><li>它规模可以比 Plist 大，4M 以内是比较推荐的值（超过4M，Console 会有 Warning）。</li><li>在性能提升的同时，也更容易导致数据丢失，不建议存储非常重要的配置数据</li></ul><h2 id=mmkv>MMKV</h2><h3 id=mmap-技术>mmap 技术</h3><p>在了解 MMKV 技术之前我们需要先了解一下 <code>mmap</code> 技术：</p><p>技术痛点：</p><ul><li>在传统读写文件时，我们通常需要在内存中自己设置 buffer；以及处理文件与内存的同步（<code>seek</code>、<code>write</code>、<code>read</code>）。这通常比较复杂，我们还需要适当的 <code>fsync</code> 调用。</li></ul><p>解决方案：</p><ul><li>Unix 操作系统提供了一个叫做 <code>mmap</code> 的函数，其底层适用 swap 实现。它将文件映射到进程的一块虚拟地址空间上，操作文件简化为直接操作内存。</li></ul><p>示例程序：下面是一个拷贝文件的示例程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>auto</span> <span class=n>mmap_src</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd_src</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>auto</span> <span class=n>mmap_dst</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd_dst</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>mmap_src</span> <span class=o>==</span> <span class=n>MAP_FAILED</span> <span class=o>||</span> <span class=n>mmap_dst</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>memcpy</span><span class=p>(</span><span class=n>mmap_dst</span><span class=p>,</span> <span class=n>mmap_src</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>因为这种方案使用了虚拟内存系统的 swap 机制，mmap 有以下特性：</p><ol><li>并不占用进程内存：他是直接映射到操作系统对 IO 设备的缓存 PageCache 上。相对于正常IO操作，他直接就省去了PageCache 复制数据到进程中的 Buffer 这一步骤，省去了一大笔内存复制的开销。</li><li>数据共享：多个进程如果映射到同一文件，因为他们会映射到相同的物理内存上。一个典型的例子就是动态库加载，动态库就是通过 <code>mmap</code> 来实现共享的。</li><li>回写特性：手动 <code>msync</code> 触发；在 <code>munmap</code>、进程被杀死、内存紧张时自动触发；部分操作系统也会定期回写。只要数据写入了内存，即使写入进程被杀死，操作系统也会负责数据的回写。</li></ol><p>注意这个技术的第三点，也就是说如果我们不关心回写磁盘的问题，操作系统也会自动完成。</p><h3 id=mmkv-技术>MMKV 技术</h3><p>什么是 MMKV（开源地址：https://github.com/Tencent/MMKV）？</p><ul><li><p>MMKV 是腾讯开源的一个 k-v 存储库，旨在替代 <code>NSUserDefault</code>；</p></li><li><p>Plist 的写入瓶颈在于文件中没有数据结构，不能直接进行查询和数据插入操作，导致每次必须全量写入序列化后的数据；</p></li><li><p>MMKV 技术使用 mmap 在内存中映射了一个简单的数据结构；这个数据结构大概是以下几个部分：</p><table><thead><tr><th>META_INFO</th><th>KEY_SIZE</th><th>KEY_VALUE</th><th>DATA_SIZE</th><th>DATA_VALUE</th></tr></thead><tbody><tr><td>一些基本信息<br>比如检测数据完整性的 CRC</td><td>键大小</td><td>键</td><td>值大小</td><td>值</td></tr></tbody></table></li></ul><p>MMKV 技术的工作流程：</p><ul><li>读数据：MMKV 在初始化的时候会通过 mmap 读取所有的数据，然后在内存中生成一个 Dictionary。</li><li>写数据：当有一个新 pair 时，首先写入缓存，然后在 <code>mmap</code> 文件尾部追加一个 pair。</li><li>注意⚠️：MMKV 文件中对于一个 Key 可能有多个 Pair 存在。即使一直操作同一个Pair，也会导致MMKV文件的增大。当 MMKV 写入的数据将要超过相关文件的大小时，MMKV 会进行 <code>mumap</code> 操作，并扩大文件长度，重新进行 <code>mmap</code> 操作，同时用内存缓存中的数据全量写入，覆写原来的 MMKV 文件内容，在此时完成 key-value 一对多的数据去重，解决了 MMKV 文件占用过大的问题。</li></ul><p>性能分析：</p><ul><li>读性能：正常时直接读取内存，所以平均读性能时间复杂度为 0；初始化时需要全量读取到内存中，并且 MMKV 不覆盖的特性每个键有多个值对应。设每个键有 k 个存储记录，时间复杂度 k*O(n)；</li><li>写性能：通常的操作仍然在内存中进行，复杂度 0；最坏情况是触发了 swap，全量写回 O(n)；</li><li>空间性能：因为冗余记录的存在，空间复杂度 k*O(n)；内存空间复杂度 O(n)。</li><li>并发性能：线程安全，但是不支持并发；</li></ul><p>MMKV 彻底解决了 <code>NSUserDefault</code> 写入性能慢的问题，写入性能几乎达到内存级别，但是偶尔还是会有全量回写的情况发生。另外 MMKV 在正常情况下大大降低了数据丢失的风险（app 被突然杀死），但是对于突然断电的情况，可能会有比较大的风险。</p><h2 id=sqlite>SQLite</h2><p>为了实现不依赖缓存的高效读/写，我们需要更高级的数据结构，基于 B-Tree 的 SQLite，是移动端目前一个比较好的选择，除了提供高效读写性能外，SQL 的强大查询能力也为我们实现高效 ORM 系统提供了基础。</p><h3 id=delete-模式>DELETE 模式</h3><p>SQLite 提供了标准的事务回滚机制。为了实现事务回滚，SQLite 提供了日志的概念，即在写入数据到 B-Tree前记录一份日志到临时文件，如果事务写入失败，则通过日志恢复老的数据。</p><p>SQLite 的默认日志模式为 DELETE 模式，即在写入完成后删除日志文件。</p><p>性能分析：</p><ul><li><p>读性能（平均与最坏相同）：假设 B-Tree 单个节点最多有 x 个孩子，则查询复杂度为 $$O(log_{x} n)$$，通常情况下，访问的节点数目不会超过 4 个。</p></li><li><p>写性能（平均与最坏相同）：查询老数据 $$O(log_x n)$$，写入日志 O(1)，写入 B-Tree $$O(log_x n)$$。 所以总共的 IO 复杂度为 $$O(2 * log_x n)$$。</p></li><li><p>空间性能：SQLite 的空间性能较差，主要是因为：</p><ol><li>B-Tree 的数据结构需要维护许多额外的索引，会带来极大的空间开销；</li><li>删除语句执行之后，默认不会删除相关的信息，而是将节点标记为可重用。</li></ol></li><li><p>并发性能：SQLite 默认提供多种线程模式，可以设置为由 SQLite 提供线程安全的保证，也可以设置为有用户自行保证。在保证每个线程使用一个连接的情况下，SQLite 也支持读并发，但不支持读写并发和写写并发。</p><p>SQLite 因为是天生多进程支持，锁级别是文件锁，文件锁的最大问题是不能像普通锁一样有自动唤醒机制，在获取锁失败后 SQLite 会过一段时间尝试再次获取锁（类似于自旋），如果超出一定的次数就会抛出 <code>SQLite-Busy</code> 错误。</p></li></ul><p>DELETE 模式下的 SQLite，在读性能上有比较好的表现，平均和最坏性能都非常稳定。但是写入性能远远慢于读性能，为了安全，频繁的<code>fsync</code> 调用也会大大拖慢写入性能。但是由于其是增量操作模式，每次操作的数据不会很大，在正常情况下，写入性能也足够使用，至少远远高于传统的文件写入方式。</p><h3 id=wal-模式>WAL 模式</h3><p>WAL 是 SQLite 新引进的一种日志技术，其旨在提升 SQLite 的写入性能，以及并发性。</p><p>工作流程：</p><ul><li>WAL 模式下 SQLite 直接将新写入的数据转化为一个日志，追加在 WAL 文件的尾部（由于是追加，这个过程是顺序写，写入性能几十倍于随机写）</li><li>追加完以后，写入操作完成。</li><li>当写入的数据量到达一定阈值（默认为 4M）的时候，通过一个叫做 checkpoint 的过程，将 WAL 中记录的日志全部统一写回 B-Tree，然后删除 WAL 文件。</li></ul><p>关于 <code>checkpoint</code> 主要会面临的难题：</p><ul><li>写入峰值（在写入操作触发了 <code>checkpoint</code> 操作时后这次写入会非常慢）、WAL 文件大小控制；</li></ul><p>性能分析：</p><ul><li><p>平均读性能：读数据时先会从 WAL 文件查找数据，文件中有一个叫做 shm 的索引文件提供加速，WAL 大小控制在 10M 以内，查找效率接近于 B-Tree；如果 WAL 文件找不到则会进入 B-Tree 中查找。所以我们可以认为 IO 复杂度为 $$O(log_x n)$$</p><p>最坏读性能：如果 WAL 文件过大，则读性能退化为线性，m 个日志记录的 IO 复杂度为 $$O(m)$$</p></li><li><p>平均写性能：写入只需要追加日志到 WAL 文件的尾部就完成了写入。又因为 WAL 文件的结构并不像 B-Tree 那样复杂，可以不需要每次写入 WAL 都进行 <code>fsync</code>，写入开销为 O(1)</p><p>最坏写性能：当 SQLite 需要进行 Checkpoint 时，首先需要从 WAL 中读取数据，其次插入B-Tree，假设WAL 文件有 m 个日志，则写入开销为 $$m * O( log_x n ) + O(m)$$</p></li><li><p>数据完整性：WAL 文件损坏较容易恢复，完整性优于 DELETE 模式；</p></li><li><p>空间性能：WAL 文件还是运行的临时文件，空间性能与 DELETE 模式相似；</p></li><li><p>并发性能：WAL 模式提供了读写并发的能力，当一个读者进入 WAL 文件时，会找到最后一个没有被写入的节点并进行 mark，如 log6，然后在这个 log 之前的数据中进行查找相关 key 比较老的副本，而数据写入依然可以并发的 Append 到 WAL 文件的尾部。由于 SQLite-Busy 的问题依然存在，如果无法处理Busy，依然可以认为SQLite在WAL模式下也没有并发能力。</p></li></ul><h2 id=yycache>YYCache</h2><p>YYCache 是一个基于 SQLite 的持久化缓存框架，其作为 YYWebImage 的配套图片缓存广为人知。</p><p>它有以下特点：</p><ul><li>YYCache 的接口是 K-V 形式的，并提供了淘汰策略。</li><li>YYCache 的持久化层由 SQLite 与文件系统混合组成。</li><li>YYCache 的 SQLite 中有一张 manifest 表来存储数据和淘汰策略相关的信息。</li></ul><p>YYCache 一些机制分析：</p><ul><li><strong>小文件优化</strong>：对于 20KB 以下的文件直接存入 SQLite，节省磁盘空间。因为使用 mmap 操作文件系统，每个单独文件的大小一定是页表大小的整数倍（4K 或 8K）；</li><li><strong>淘汰机制</strong>：为了维护 LRU (Least Recently Used) 相关数据，YYCache 每次读写入一个数据还需要额外记录 <code>last_access_time</code> 和 <code>modification_time</code> 数据，同时在整体大小超过阈值的时候，Query 全表找到最老的数据并批量删除。这为整个系统带来了额外的开销。</li><li><strong><code>checkpoint</code> 策略</strong>：YYCache 使用 SQLite 的 WAL 模式，并采用了默认的Checkpoint 策略。</li><li><strong>注意</strong>⚠️：YYCache 的原生实现在进行读取操作后并没有进行 reset（只在每次读操作开始前 reset），这可能导致读行为一直不结束，进而导致 Checkpoint 无法回收正在被读取的数据，极端情况下会导致 WAL 膨胀到 GB 级别，最终导致 WAL 的 Checkpoint 永远无法完成，数据库读写操作全部直接卡死。</li></ul><p>性能分析：</p><ul><li><p>平均读性能：通常情况下，读数据时，为了维护 LRU 信息，还需要进行一次 <code>last_access_time</code> 写操作，所以其 IO 性能为 $$O(log_x n) + O(1)$$。如果命中了缓存，则只有写 IO 操作，即 O(1)。</p><p>最坏读性能：就是触发 checkpoint 时，WAL 文件有 m 个日志，则 IO 性能为 $$m * O( log_x n ) + O(m) + O(log_x n)$$</p></li><li><p>平均写性能，同 WAL 模式的 SQLite，O(1)</p></li><li><p>最坏写性能，如果触发了 LRU 阈值，会进行全表扫描以及 delete，再加上 checkpoint，IO 复杂度为 $$O(n) + m * O( log_x n ) + O(m)$$</p></li><li><p>数据完整性能，同 WAL 模式的 SQLite。</p></li><li><p>空间性能，由于有额外字段记录 LRU 信息，会大于存储数据的本身，另外 YYCache 有内存缓存，大小是常数 k，复杂度为 O(k)。</p></li><li><p>并发性能，YYCache 采用了互斥模式，线程安全，但不能并发。</p></li></ul><p>YYCache 作为一个缓存框架本身是很优秀的，特别在存储图片时，还会根据文件大小选择最合适的方案进行存储，减小了磁盘占用和碎片文件，提升了写入效率。但是 LRU 本身的开销还是非常大，基于全盘扫描的淘汰以及默认的 checkpoint 策略可能会导致比较严重的卡顿，自身的 Bug 还可能导致用户无限 ANR，空间占用也比较大。虽然 YYCache 的接口是 K-V 的，但是我们建议，当需要有淘汰机制的时候才选择 YYCache，如果只是需要一个 K-V 库请选用其他方案或者自己实现。</p><h2 id=wcdb>WCDB</h2><p>WCDB 是腾讯开源的一个 SQLite 封装，其提供了高速 ORM 系统，以及针对 SQLite 进行了不少优化。</p><p>下面列举这个封装做的几件事情：</p><ul><li><strong>优化并发能力</strong>：在WCDB 为了解决 SQLite-Busy 的问题，直接修改源码去除了 SQLite 的文件锁，使用正常的唤醒机制替换。这使得 SQLite 的并发能力得到充分的释放。</li><li><strong><code>checkpoint</code> 策略</strong>：SQLite 默认策略执行的两个缺点是，写入峰值与 WAL 文件无限增长：<ul><li>对于前者，WCDB 使用异步 checkpoint 的方式：定义 <code>sqlite3_wal_hook</code> 函数用于执行 checkpoint，WAL 文件大小超过阈值后，开启新的线程等待 2s 执行这个函数，从而不会阻塞写入；</li><li>对于后者，为了防止 WAL 文件无限增长，当文件大小超过阈值后，WCDB 会锁死 DB，阻塞新的读写操作，直到 checkpoint 完成。</li></ul></li></ul><p>性能分析：</p><ul><li><p>平均与最坏写性能均为 $$O(log_x n)$$；</p></li><li><p>平均写性能为 O(1)，最坏写性能为执行 checkpoint 时，因为进行了异步优化，所以用户无感知；</p></li><li><p>数据完整性能：WCDB 会定期备份 master 表，并在损坏时自动恢复，数据完整性能优于 WAL 模式的 SQLite。</p></li><li><p>空间性能：除了数据库开销外，还有备份 master 表的开销，但是该开销是固定的，所以空间性能和 WAL 模式下的 SQLite 类似。</p></li><li><p>并发性能：线程安全，支持读读并发，读写并发，不支持写并发。</p></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-11-12</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://shesl-meow.github.io/posts/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/ data-title=:floppy_disk:客户端本地存储技术 data-hashtags=客户端,Database><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://shesl-meow.github.io/posts/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/ data-hashtag=客户端><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://shesl-meow.github.io/posts/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/ data-title=:floppy_disk:客户端本地存储技术 data-ralateuid=3968720593><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/%E5%AE%A2%E6%88%B7%E7%AB%AF/>客户端</a>,&nbsp;<a href=/tags/database/>Database</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/c++%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E6%A2%B3%E7%90%86/ class=prev rel=prev title="C++ 知识结构系统梳理"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>C++ 知识结构系统梳理</a>
<a href=/posts/%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE%E5%BA%93-mongodb-%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/ class=next rel=next title=":page_facing_up:文档数据库 MongoDB 原理浅析">📄文档数据库 MongoDB 原理浅析<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shesl-meow.github.io target=_blank>佘崧林</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.4.18/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{valine:{appId:"zDVJohJIQbD6f3W267xtaYRC-gzGzoHsz",appKey:"ewsfU9ocNOeuvt0MzONe6yKx",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"你的评论 ...",recordIP:!0,serverURLs:"https://zdvjohji.lc-cn-n1-shared.com",visitor:!0}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"",algoliaIndex:"",algoliaSearchKey:"",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.480e58b2c2a8605d406f34667e92ff8f1ae50cfee5b653bead570f004839a983.js integrity="sha256-SA5YssKoYF1AbzRmfpL/jxrlDP7ltlO+rVcPAEg5qYM="></script></body></html>