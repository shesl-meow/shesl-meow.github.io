<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>:truck:å †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é… - shesl's blog</title><meta name=Description content="ä½˜å´§æ—åŒå­¦çš„ç¢ç¢å¿µåšå®¢"><meta property="og:title" content=":truck:å †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é…">
<meta property="og:description" content="å‚è€ƒï¼š é•¿äº­ç§‘æŠ€, å †çš„æ¦‚å¿µ http://p4nda.top/2018/03/20/tcache/ https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/ ä»€ä¹ˆæ˜¯å † å †çš„ä¸€äº›ç‰¹ç‚¹ï¼š å †æ˜¯å¯ä»¥æ ¹æ®è¿è¡Œæ—¶çš„éœ€è¦è¿›è¡ŒåŠ¨æ€åˆ†é…å’Œé‡Šæ”¾çš„å†…å­˜ï¼Œå¤§å°å¯å˜ï¼› å †çš„å®ç°é‡ç‚¹å…³æ³¨å†…å­˜å—çš„ç»„ç»‡å’Œ"><meta property="og:type" content="article"><meta property="og:url" content="http://shesl-meow.github.io/posts/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/"><meta property="og:image" content="http://shesl-meow.github.io/avatar.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-02T23:45:34+08:00"><meta property="article:modified_time" content="2019-08-02T23:45:34+08:00"><meta property="og:site_name" content="shesl's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://shesl-meow.github.io/avatar.png"><meta name=twitter:title content=":truck:å †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é…"><meta name=twitter:description content="å‚è€ƒï¼š é•¿äº­ç§‘æŠ€, å †çš„æ¦‚å¿µ http://p4nda.top/2018/03/20/tcache/ https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/ ä»€ä¹ˆæ˜¯å † å †çš„ä¸€äº›ç‰¹ç‚¹ï¼š å †æ˜¯å¯ä»¥æ ¹æ®è¿è¡Œæ—¶çš„éœ€è¦è¿›è¡ŒåŠ¨æ€åˆ†é…å’Œé‡Šæ”¾çš„å†…å­˜ï¼Œå¤§å°å¯å˜ï¼› å †çš„å®ç°é‡ç‚¹å…³æ³¨å†…å­˜å—çš„ç»„ç»‡å’Œ"><meta name=application-name content="shesl's blog"><meta name=apple-mobile-web-app-title content="shesl's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://shesl-meow.github.io/posts/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/><link rel=prev href=http://shesl-meow.github.io/posts/%E6%A6%82%E5%BF%B5%E5%AD%A6%E4%B9%A0%E4%B8%8E%E9%9D%A2%E8%AF%95%E9%A2%98/><link rel=next href=http://shesl-meow.github.io/posts/elf%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90%E6%8C%87%E5%8C%97/><link rel=stylesheet href=/css/style.min.f9dcece0006720752966c5ab2d548675424bb8b985943a9e2d120f7b736cf8eb.css integrity="sha256-+dzs4ABnIHUpZsWrLVSGdUJLuLmFlDqeLRIPe3Ns+Os="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":":truck:å †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é…","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/shesl-meow.github.io\/posts\/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D\/"},"genre":"posts","keywords":"Linux, æœåŠ¡ç«¯, ä¿¡æ¯å®‰å…¨, C\u002b\u002b","wordcount":4701,"url":"http:\/\/shesl-meow.github.io\/posts\/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D\/","datePublished":"2019-08-02T23:45:34+08:00","dateModified":"2019-08-02T23:45:34+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"ä½˜å´§æ—"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><script src=https://unpkg.com/vue@2></script><div class=header-wrapper><div class=header-title><a href=/ title="shesl's blog">shesl-meow</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>åšå®¢
</a><a class=menu-item href=/tags/>æ ‡ç­¾
</a><a class=menu-item href=/categories/>åˆ†ç±»
</a><a class=menu-item href=/note/>ç¬”è®°</a><div class=dropdown><a class="menu-item menu-more dropbtn" title href=javascript:void(0);>æ¸¸æˆ</a><div class="menu-more-content dropdown-content"><a href=/games/2048/ title><i class='fa-solid fa-puzzle-piece'></i> 2048 </a><a href=/games/schulte/ title><i class='fa-solid fa-chess-board'></i> Schulte</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="shesl's blog">shesl-meow</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/>åšå®¢
</a><a class=menu-item href=/tags/>æ ‡ç­¾
</a><a class=menu-item href=/categories/>åˆ†ç±»
</a><a class=menu-item href=/note/>ç¬”è®°</a><div class=dropdown><a class="menu-item menu-more dropbtn" title href=javascript:void(0);>æ¸¸æˆ</a><div class="menu-more-content dropdown-content"><a href=/games/2048/ title><i class='fa-solid fa-puzzle-piece'></i> 2048 </a><a href=/games/schulte/ title><i class='fa-solid fa-chess-board'></i> Schulte</a></div></div><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ğŸššå †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é…</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://shesl-meow.github.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>ä½˜å´§æ—</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-08-02>2019-08-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 4701 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 10 åˆ†é’Ÿ&nbsp;<span id=/posts/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/ class=leancloud_visitors data-flag-title=:truck:å †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é…>
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#ä»€ä¹ˆæ˜¯å †>ä»€ä¹ˆæ˜¯å †</a></li><li><a href=#glibc-ç›¸å…³ç»“æ„>Glibc ç›¸å…³ç»“æ„</a><ul><li><a href=#arena><code>arena</code></a></li><li><a href=#malloc_state><code>malloc_state</code></a></li><li><a href=#malloc_chunks><code>malloc_chunks</code></a></li><li><a href=#fastbins><code>fastbins</code></a></li><li><a href=#bins-small--large--unsorted><code>bins</code> (<code>small & large & unsorted</code>)</a></li></ul></li><li><a href=#glibc-ç›¸å…³å‡½æ•°>Glibc ç›¸å…³å‡½æ•°</a><ul><li><a href=#malloc><code>malloc()</code></a></li><li><a href=#free><code>free()</code></a></li><li><a href=#unlink><code>unlink()</code></a></li></ul></li><li><a href=#å¤šçº¿ç¨‹ä¼˜åŒ–æ‰‹æ®µ-tcache>å¤šçº¿ç¨‹ä¼˜åŒ–æ‰‹æ®µ <code>tcache</code></a><ul><li><a href=#ç®€ä»‹>ç®€ä»‹</a></li><li><a href=#tcache_entry--tcache_perthread_struct><code>tcache_entry</code> && <code>tcache_perthread_struct</code></a></li><li><a href=#tcache_get--tcache_put><code>tcache_get</code> && <code>tcache_put</code></a></li><li><a href=#_int_free><code>_int_free</code></a></li><li><a href=#_int_malloc><code>_int_malloc</code></a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>å‚è€ƒï¼š</p><ul><li>é•¿äº­ç§‘æŠ€, å †çš„æ¦‚å¿µ</li><li><a href=http://p4nda.top/2018/03/20/tcache/ target=_blank rel="noopener noreffer">http://p4nda.top/2018/03/20/tcache/</a></li><li><a href=https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/ target=_blank rel="noopener noreffer">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/</a></li></ul></blockquote><h2 id=ä»€ä¹ˆæ˜¯å †>ä»€ä¹ˆæ˜¯å †</h2><p>å †çš„ä¸€äº›ç‰¹ç‚¹ï¼š</p><ul><li>å †æ˜¯å¯ä»¥æ ¹æ®è¿è¡Œæ—¶çš„éœ€è¦è¿›è¡ŒåŠ¨æ€åˆ†é…å’Œé‡Šæ”¾çš„å†…å­˜ï¼Œå¤§å°å¯å˜ï¼›</li><li>å †çš„å®ç°é‡ç‚¹å…³æ³¨å†…å­˜å—çš„ç»„ç»‡å’Œç®¡ç†æ–¹å¼ï¼ˆå°¤å…¶æ—¶ç©ºé—²çš„å†…å­˜å—ï¼‰ï¼š<ul><li>å¦‚ä½•æé«˜åˆ†é…å’Œé‡Šæ”¾çš„æ—¶é—´æ•ˆç‡ï¼›</li><li>å¦‚ä½•é™ä½ç¢ç‰‡åŒ–ï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡ï¼›</li></ul></li></ul><p>å¸¸è§å †çš„å®ç°ï¼š</p><ul><li><code>dlmalloc</code>ï¼šé€šç”¨åˆ†é…å™¨ï¼›</li><li><strong><code>ptmalloc2</code>ï¼š<code>glibc</code> å‡½æ•°ï¼ŒåŸºäº <code>dlmalloc</code>ï¼Œæ”¯æŒå¤šçº¿ç¨‹</strong>ï¼›</li><li><code>jemalloc</code>ï¼š<code>FreeBSD</code>ã€<code>FireFox</code>ã€<code>Android</code>ï¼›å†…å­˜å ç”¨æ›´é«˜ï¼Œä½†æ˜¯åœ¨å¤šæ ¸å¤šçº¿ç¨‹ä¸‹çš„è¡¨ç°ä¹Ÿæœ€ä¸ºä¼˜å¼‚ã€‚</li><li><code>tcmalloc</code>ï¼š<code>Google Chrome</code>ã€<code>Golang</code>ï¼›é’ˆå¯¹å¤šæ ¸æƒ…å†µæœ‰æ‰€ä¼˜åŒ–ï¼Œæ€§èƒ½æœ‰æ‰€æé«˜ï¼Œä½†æ˜¯å†…å­˜å ç”¨ç¨é«˜ï¼Œå¤§å†…å­˜åˆ†é…å®¹æ˜“å‡ºç° CPU é£™å‡ã€‚</li><li><code>libumem</code>ï¼š<code>Solaris</code>ï¼›</li><li><code>Windows 10</code>ï¼š<code>segment heap</code>ã€‚</li></ul><blockquote><p>ç›¸å…³èµ„æ–™ï¼š</p><ul><li><a href=https://www.cyningsun.com/07-07-2018/memory-allocator-contrasts.html#%E7%B3%BB%E7%BB%9F%E5%90%91%E7%9C%8Bptmalloc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86 target=_blank rel="noopener noreffer">https://www.cyningsun.com/07-07-2018/memory-allocator-contrasts.html#%E7%B3%BB%E7%BB%9F%E5%90%91%E7%9C%8Bptmalloc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86</a></li></ul></blockquote><h2 id=glibc-ç›¸å…³ç»“æ„>Glibc ç›¸å…³ç»“æ„</h2><p>ä¸‹é¢ä»‹ç»ç®¡ç† <code>glic</code> å †çš„å„ç§æ•°æ®ç»“æ„ï¼š</p><h3 id=arena><code>arena</code></h3><p><code>arena</code> æŒ‡çš„æ˜¯å†…å­˜åŒºåŸŸæœ¬èº«ï¼Œå¹¶éä¸€ä¸ªç»“æ„ï¼š</p><ol><li>ä¸»çº¿ç¨‹çš„å †ç”± <code>sbrk</code> åˆ›å»ºï¼Œç§°ä¸º <strong><code>main arena</code></strong>ï¼›</li><li>å…¶ä»–çº¿ç¨‹çš„å †ç”± <code>mmap</code> åˆ›å»ºï¼Œç§°ä¸º <strong><code>per thread arena</code></strong>ï¼›</li></ol><p><code>arena</code> çš„æ•°é‡å— CPU æ ¸æ•°çš„é™åˆ¶ï¼š</p><ul><li>å¯¹äº 32 ä½ç³»ç»Ÿï¼š<code>æ•°é‡ä¸Šé™ = 2 * æ ¸æ•°</code></li><li>å¯¹äº 64 ä½ç³»ç»Ÿï¼š<code>æ•°é‡ä¸Šé™ = 8 * æ ¸æ•°</code></li></ul><h3 id=malloc_state><code>malloc_state</code></h3><p>å®ƒæ˜¯ç®¡ç† <code>arena</code> çš„æ ¸å¿ƒç»“æ„ï¼Œå…¶å®šä¹‰åœ¨ <code>glibc</code> æºç çš„ <code>/malloc/malloc.c</code> è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>malloc_state</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Serialize access.  */</span>
</span></span><span class=line><span class=cl>  <span class=nf>__libc_lock_define</span> <span class=p>(,</span> <span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Flags (formerly in max_fast).  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Note this is a bool but not all targets support atomics on booleans.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>have_fastchunks</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Fastbins */</span>
</span></span><span class=line><span class=cl>  <span class=n>mfastbinptr</span> <span class=n>fastbinsY</span><span class=p>[</span><span class=n>NFASTBINS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* The remainder from the most recent split of a small request */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>last_remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Normal bins packed as described above */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>bins</span><span class=p>[</span><span class=n>NBINS</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Bitmap of bins */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>binmap</span><span class=p>[</span><span class=n>BINMAPSIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Linked list */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_state</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Linked list for free arenas.  Access to this field is serialized
</span></span></span><span class=line><span class=cl><span class=cm>     by free_list_lock in arena.c.  */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_state</span> <span class=o>*</span><span class=n>next_free</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Number of threads attached to this arena.  0 if the arena is on
</span></span></span><span class=line><span class=cl><span class=cm>     the free list.  Access to this field is serialized by
</span></span></span><span class=line><span class=cl><span class=cm>     free_list_lock in arena.c.  */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>attached_threads</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Memory allocated from the system in this arena.  */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>system_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>max_system_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>åŒæ ·åœ¨æ–‡ä»¶ <code>/malloc/malloc.c</code> ä¸­ï¼Œå®šä¹‰äº†å…¨å±€å˜é‡ <code>main_arena</code> ç®¡ç†ä¸»çº¿ç¨‹çš„ <code>malloc_state</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>malloc_state</span> <span class=n>main_arena</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>mutex</span> <span class=o>=</span> <span class=n>_LIBC_LOCK_INITIALIZER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>next</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>attached_threads</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=malloc_chunks><code>malloc_chunks</code></h3><p>å†…å­˜å—çš„ç»“æ„ï¼Œ<code>glibc</code> æºç çš„ <code>./malloc/malloc.c</code> è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>malloc_chunk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span>      <span class=n>mchunk_prev_size</span><span class=p>;</span>  <span class=cm>/* Size of previous chunk (if free).  */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span>      <span class=n>mchunk_size</span><span class=p>;</span>       <span class=cm>/* Size in bytes, including overhead. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_chunk</span><span class=o>*</span> <span class=n>fd</span><span class=p>;</span>         <span class=cm>/* double links -- used only if free. */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_chunk</span><span class=o>*</span> <span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Only used for large blocks: pointer to next larger size.  */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_chunk</span><span class=o>*</span> <span class=n>fd_nextsize</span><span class=p>;</span> <span class=cm>/* double links -- used only if free. */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_chunk</span><span class=o>*</span> <span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>ç©ºé—²å†…å­˜å—çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼ˆå­—æ®µå³ä¾§ä¸º32 ä½å¹³å°ä¸‹çš„æ¯”ç‰¹ä½é•¿ï¼‰ï¼š</p><img src=./free_chunk.jpg width=50%><ol><li>ç¬¬ä¸€ä¸ªå­—æ®µ <code>prev_size</code> å­˜å‚¨äº†ï¼Œç‰©ç†åœ°å€ä¸Šçš„å‰ä¸€ä¸ª <code>chunk</code> çš„å¤§å°ã€‚</li><li>ç¬¬äºŒä¸ªå­—æ®µ <code>size</code> è®°å½•äº†å½“å‰ <code>chunk</code> çš„å¤§å°ã€‚æœ€åä¸‰ä¸ªæ¯”ç‰¹ä½è¢«ç”¨ä½œå…¶ä»–å«ä¹‰ï¼š<ol><li><code>P</code> ä»£è¡¨ <code>PREV_INUSE</code>ï¼ŒæŒ‡æ˜å‰ä¸€ä¸ª <code>chunk</code> æ˜¯å¦è¢«ä½¿ç”¨ï¼›</li><li><code>M</code> ä»£è¡¨ <code>IS_MAPPED</code>ï¼Œä»£è¡¨å½“å‰çš„ <code>chunk</code> æ˜¯å¦é€šè¿‡ <code>mmap</code> æ–¹å¼åˆ›å»ºå‡ºæ¥çš„ï¼›</li><li><code>N</code> ä»£è¡¨ <code>NON_MAIN_ARENA</code>ï¼Œä»£è¡¨å½“å‰ <code>chunk</code> æ˜¯å¦å±äºå…¶ä»–çº¿ç¨‹å †ï¼ˆä¸»çº¿ç¨‹å€¼ä¸º 0ï¼‰ï¼›</li></ol></li><li>ç¬¬ä¸‰å››ä¸ªå­—æ®µä¸ºå‰å‘æŒ‡é’ˆä¸åå‘æŒ‡é’ˆï¼Œè¿™ä¸¤ä¸ªå­—æ®µç”¨äº <code>bin</code> é“¾è¡¨ä¸­ã€‚</li></ol><p>å·²åˆ†é…å†…å­˜å—çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p><img src=./allocated_chunk.jpg width=70%><ol><li><p>å‰ä¸¤ä¸ªå­—æ®µä¸ç©ºé—²çš„å†…å­˜å—å¤§è‡´ç›¸åŒï¼›</p></li><li><p>ç”¨æˆ·å¯ç”¨çš„æ•°æ®æ˜¯ç¬¬ä¸‰ä¸ªå­—æ®µå¼€å§‹ä¸€ç›´åˆ°ä¸‹ä¸€ä¸ª <code>chunk</code> çš„ç¬¬ä¸€ä¸ªå­—æ®µã€‚è¿™æ˜¯å› ä¸ºï¼š</p><ul><li><code>prev_size</code> åªæœ‰å½“å‰ä¸€ä¸ªå­—æ®µæ˜¯ç©ºé—²çš„æ—¶å€™æ‰æœ‰æ„ä¹‰ï¼Œå¦‚æœå‰ä¸€ä¸ªå­—æ®µå·²ç»åˆ†é…ï¼Œå †ç®¡ç†å™¨ä¸å…³å¿ƒï¼›</li></ul><p>è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ 32 ä½ç¨‹åºä¸­ï¼Œå¦‚æœç”¨æˆ·ç”³è¯·äº† 16 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå…¶å¯¹åº”çš„ <code>chunk</code> æ•°æ®ç»“æ„çš„ <code>data</code> æ®µåªä¼šæœ‰ 12 ä¸ªå­—èŠ‚ï¼Œç”¨æˆ·åŠ ä¸Šä¸‹ä¸€ä¸ª <code>chunk</code> çš„ <code>prev_size</code> ç©ºé—´ï¼Œä¸€å…±å¯ä»¥ä½¿ç”¨ 16 ä¸ªå­—èŠ‚ã€‚</p><p>ä½†æ˜¯ <code>size</code> è®°å½•çš„æ˜¯ <code>prev_size</code> èµ·å§‹åˆ°ä¸‹ä¸€ä¸ª <code>prev_size</code> èµ·å§‹ä¹‹é—´çš„å¤§å°ã€‚</p></li><li><p>åœ¨ 32 ä½å¹³å°ä¸‹ï¼Œ<code>chunk</code> çš„å¤§å°ä¸€å®šæ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€ï¼ˆæ‰€ä»¥ <code>size</code> çš„æœ€ä½ä¸‰ä¸ªæ¯”ç‰¹ä½æ˜¯æ— ç”¨çš„ï¼‰ã€‚<code>malloc</code> è¿”å›åœ°å€æŒ‡é’ˆä¸º <code>data</code> çš„èµ·å§‹ä½ç½®ã€‚</p></li></ol><h3 id=fastbins><code>fastbins</code></h3><p><code>bins</code> æ˜¯æ ¹æ® <code>chunk</code> çš„å¤§å°å’ŒçŠ¶æ€ï¼Œç”¨æ¥ç®¡ç†å’Œç»„ç»‡ç©ºé—²å—çš„ï¼Œé“¾è¡¨çš„æ•°ç»„ç»“æ„ã€‚</p><p><code>fastbins</code> ç”¨äºç®¡ç†æœ€å°çš„ <code>chunk</code>ã€‚ä»–å­˜å‚¨åœ¨äº† <code>malloc_state</code> ä¸­çš„æ•°ç»„å˜é‡ <code>fastbinsY</code> ä¸­ã€‚å®ƒåŒæ ·å®šä¹‰åœ¨ <code>/malloc/malloc.c</code> è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   Fastbins
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    An array of lists holding recently freed small chunks.  Fastbins
</span></span></span><span class=line><span class=cl><span class=cm>    are not doubly linked.  It is faster to single-link them, and
</span></span></span><span class=line><span class=cl><span class=cm>    since chunks are never removed from the middles of these lists,
</span></span></span><span class=line><span class=cl><span class=cm>    double linking is not necessary. Also, unlike regular bins, they
</span></span></span><span class=line><span class=cl><span class=cm>    are not even processed in FIFO order (they use faster LIFO) since
</span></span></span><span class=line><span class=cl><span class=cm>    ordering doesn&#39;t much matter in the transient contexts in which
</span></span></span><span class=line><span class=cl><span class=cm>    fastbins are normally used.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    Chunks in fastbins keep their inuse bit set, so they cannot
</span></span></span><span class=line><span class=cl><span class=cm>    be consolidated with other free chunks. malloc_consolidate
</span></span></span><span class=line><span class=cl><span class=cm>    releases all chunks in fastbins and consolidates them with
</span></span></span><span class=line><span class=cl><span class=cm>    other free chunks.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>malloc_chunk</span> <span class=o>*</span><span class=n>mfastbinptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥å¾—å‡ºå®ƒæœ‰ä»¥ä¸‹è¿™äº›ç‰¹ç‚¹ï¼š</p><ol><li>å®ƒæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼ˆå› ä¸ºä»æ¥ä¸ä¼šéœ€è¦ä»ä¸­é—´ç§»é™¤å…ƒç´ çš„æ“ä½œï¼Œä¸éœ€è¦åŒå‘é“¾è¡¨ï¼‰ï¼›</li><li>åè¿›å…ˆå‡ºï¼ˆå…¶ä»–çš„åƒåœ¾å›æ”¶ç»“æ„æ˜¯å…ˆè¿›å…ˆå‡ºï¼‰ï¼›</li><li><code>chunk</code> è¢«æ¸…ç†æ—¶ï¼Œ<code>PREV_INUSE</code> æ ‡å¿—ä½ä¸ä¼šè¢«æ¸…é›¶ï¼›</li><li>32 ä½ç³»ç»Ÿä¸­ï¼Œ<code>fastbin</code> ä¸­é»˜è®¤æ”¯æŒæœ€å¤§çš„ chunk çš„æ•°æ®ç©ºé—´å¤§å°ä¸º 64 å­—èŠ‚ã€‚ä½†æ˜¯ <code>glibc</code> å¯ä»¥æ”¯æŒçš„ chunk çš„æ•°æ®ç©ºé—´æœ€å¤§ä¸º 80 å­—èŠ‚ã€‚</li><li>ä¸€å…±æœ‰åä¸ª <code>fastbins</code>ï¼›</li><li>ç›¸é‚»çš„ç©ºé—²çš„ <code>fastbin chunk</code> ä¸ä¼šè¢«åˆå¹¶ã€‚</li></ol><p>ä¸‹é¢æ˜¯ä¸€ä¸ª 32 ä½ç¨‹åºåœ¨è¿è¡Œæ—¶çš„ <code>fastbins</code> ç¤ºä¾‹å›¾ï¼š</p><img src=./fastbins_example.jpg><h3 id=bins-small--large--unsorted><code>bins</code> (<code>small & large & unsorted</code>)</h3><p>æºç ä¸­æœ‰ä¸€æ®µæ³¨é‡Šè§£é‡Šè¿™äº› <code>bins</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>   Bins
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    An array of bin headers for free chunks. Each bin is doubly
</span></span></span><span class=line><span class=cl><span class=cm>    linked.  The bins are approximately proportionally (log) spaced.
</span></span></span><span class=line><span class=cl><span class=cm>    There are a lot of these bins (128). This may look excessive, but
</span></span></span><span class=line><span class=cl><span class=cm>    works very well in practice.  Most bins hold sizes that are
</span></span></span><span class=line><span class=cl><span class=cm>    unusual as malloc request sizes, but are more usual for fragments
</span></span></span><span class=line><span class=cl><span class=cm>    and consolidated sets of chunks, which is what these bins hold, so
</span></span></span><span class=line><span class=cl><span class=cm>    they can be found quickly.  All procedures maintain the invariant
</span></span></span><span class=line><span class=cl><span class=cm>    that no consolidated chunk physically borders another one, so each
</span></span></span><span class=line><span class=cl><span class=cm>    chunk in a list is known to be preceeded and followed by either
</span></span></span><span class=line><span class=cl><span class=cm>    inuse chunks or the ends of memory.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    Chunks in bins are kept in size order, with ties going to the
</span></span></span><span class=line><span class=cl><span class=cm>    approximately least recently used chunk. Ordering isn&#39;t needed
</span></span></span><span class=line><span class=cl><span class=cm>    for the small bins, which all contain the same-sized chunks, but
</span></span></span><span class=line><span class=cl><span class=cm>    facilitates best-fit allocation for larger chunks. These lists
</span></span></span><span class=line><span class=cl><span class=cm>    are just sequential. Keeping them in order almost never requires
</span></span></span><span class=line><span class=cl><span class=cm>    enough traversal to warrant using fancier ordered data
</span></span></span><span class=line><span class=cl><span class=cm>    structures.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    Chunks of the same size are linked with the most
</span></span></span><span class=line><span class=cl><span class=cm>    recently freed at the front, and allocations are taken from the
</span></span></span><span class=line><span class=cl><span class=cm>    back.  This results in LRU (FIFO) allocation order, which tends
</span></span></span><span class=line><span class=cl><span class=cm>    to give each chunk an equal opportunity to be consolidated with
</span></span></span><span class=line><span class=cl><span class=cm>    adjacent freed chunks, resulting in larger free chunks and less
</span></span></span><span class=line><span class=cl><span class=cm>    fragmentation.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>    To simplify use in double-linked lists, each bin header acts
</span></span></span><span class=line><span class=cl><span class=cm>    as a malloc_chunk. This avoids special-casing for headers.
</span></span></span><span class=line><span class=cl><span class=cm>    But to conserve space and improve locality, we allocate
</span></span></span><span class=line><span class=cl><span class=cm>    only the fd/bk pointers of bins, and then use repositioning tricks
</span></span></span><span class=line><span class=cl><span class=cm>    to treat these as the fields of a malloc_chunk*.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ <code>small bins</code> æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š</p><ol><li><code>chunk</code> çš„å¤§å°å°äº 512 å­—èŠ‚ï¼›</li><li>å…±æœ‰ 62 ä¸ªåŒå‘å¾ªç¯é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­å­˜å‚¨ç€ç›¸åŒå¤§å°çš„ <code>chunk</code>ï¼›</li><li>å…ˆè¿›å…ˆå‡ºï¼›</li><li>å½“æœ‰ç›¸é‚»çš„ç©ºé—²å†…å­˜å—æ—¶ï¼Œ<code>chunk</code> ä¼šè¢«åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„ <code>chunk</code>ã€‚</li></ol><p><code>large bins</code> æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š</p><ol><li><code>chunk</code> çš„å¤§å°å¤§äº 512 å­—èŠ‚ï¼›</li><li>å…±æœ‰ 63 ä¸ªåŒå‘å¾ªç¯é“¾è¡¨ï¼Œå¤§å°ç›¸è¿‘çš„ <code>chunk</code> æ”¾åœ¨åŒä¸€ä¸ª <code>bin</code> ä¸­ï¼›</li><li><code>chunk</code> æŒ‰ç…§å¤§å°ä»å¤§åˆ°å°æ’åºï¼›</li><li>å…ˆè¿›å…ˆå‡ºï¼›</li><li>å½“æœ‰ç›¸é‚»çš„ç©ºé—²å†…å­˜å—æ—¶ï¼Œ<code>chunk</code> ä¼šè¢«åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„ <code>chunk</code>ã€‚</li></ol><p><code>unsorted bins</code> æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š</p><ol><li><code>chunk</code> çš„å¤§å°å¤§äº 64 ä¸ªå­—èŠ‚ï¼›</li><li>åªæœ‰å”¯ä¸€ä¸€ä¸ªåŒå‘å¾ªç¯é“¾è¡¨ï¼›</li><li>å½“ä¸€ä¸ªé <code>fastbin</code> çš„ <code>chunk</code> è¢«é‡Šæ”¾ä¹‹åï¼Œå®ƒé¦–å…ˆè¢«æ”¾å…¥ <code>unsorted bin</code> ç­‰åç»­æ•´ç†æ—¶ï¼Œæ‰ä¼šæ”¾å…¥å¯¹åº”çš„ <code>small bin/fast bin</code>ã€‚</li></ol><p>è¿™ä¸‰ä¸ª <code>bins</code> å…±äº«ä¸€ä¸ª <code>malloc_state</code> ä¸­çš„å˜é‡ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Normal bins packed as described above */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>bins</span><span class=p>[</span><span class=n>NBINS</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>-</span> <span class=mi>2</span><span class=p>];</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­ä¸‰ç§ <code>bins</code> çš„æ’åˆ—å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src=./arena.bins_structure.jpg><h2 id=glibc-ç›¸å…³å‡½æ•°>Glibc ç›¸å…³å‡½æ•°</h2><h3 id=malloc><code>malloc()</code></h3><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li>åœ¨ <code>fast bins</code> ä¸­å¯»æ‰¾ <code>fast chunk</code>ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç»“æŸï¼›</li><li>åœ¨ <code>small bins</code> ä¸­å¯»æ‰¾ <code>small chunk</code>ï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç»“æŸï¼›</li><li>å¾ªç¯ï¼š<ol><li>æ£€æŸ¥ <code>unsorted bin</code> ä¸­çš„ <code>last_remainder</code>ã€‚å¦‚æœå®ƒè¶³å¤Ÿå¤§å¤§åˆ™åˆ†é…è¿™ä¸ª <code>chunk</code>ï¼Œå¹¶å°†å‰©ä½™çš„ <code>chunk</code> æ ‡è®°ä¸ºæ–°çš„ <code>last_remainer</code>ï¼›</li><li>åœ¨ <code>unsorted bin</code> ä¸­æœç´¢ï¼ŒåŒæ—¶è¿›è¡Œæ•´ç†ã€‚å¦‚æœé‡åˆ°ç²¾ç¡®å¤§å°åˆ™è¿”å›ï¼Œå¦åˆ™å°† <code>chunk</code> æ•´ç†åˆ°å®ƒå¯¹åº”å¤§å°çš„ <code>small/large bins</code> ä¸­å»ï¼›</li><li>åœ¨ <code>small bin</code> å’Œ <code>large bin</code> ä¸­æœç´¢æœ€åˆé€‚çš„ <code>chunk</code>ï¼ˆä¸ä¸€å®šç²¾ç¡®ï¼‰ï¼›</li></ol></li><li>ä½¿ç”¨ <code>top chunk</code>ã€‚</li></ol><h3 id=free><code>free()</code></h3><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li>å¦‚æœæ˜¯ <code>fast chunk</code>ï¼Œåˆ™æ”¾å…¥ <code>fast bin</code>ï¼›</li><li>å¦‚æœå‰ä¸€ä¸ª <code>chunk</code> æ˜¯ç©ºé—²çš„ï¼š<ol><li><code>unlink</code> å‰é¢çš„ <code>chunk</code>ï¼›</li><li>åˆå¹¶ä¸¤ä¸ª <code>chunk</code>ï¼Œå¹¶ä¸”æ”¾å…¥ <code>unsorted bin</code>ï¼›</li></ol></li><li>å¦‚æœåä¸€ä¸ª <code>chunk</code> æ˜¯ <code>top chunk</code>ï¼Œåˆ™å°†å½“å‰ <code>chunk</code> å¹¶å…¥ <code>top chunk</code>ï¼›</li><li>å¦‚æœåä¸€ä¸ª <code>chunk</code> æ˜¯ç©ºé—²çš„ï¼š<ol><li><code>unlink</code> åé¢çš„ <code>chunk</code>ï¼›</li><li>åˆå¹¶ä¸¤ä¸ª <code>chunk</code>ï¼Œå¹¶ä¸”æ”¾å…¥ <code>unsorted bin</code>ï¼›</li></ol></li><li>å‰åä¸¤ä¸ª <code>chunk</code> éƒ½ä¸æ˜¯ç©ºé—²çš„ï¼Œç›´æ¥æ”¾å…¥ <code>unsorted bin</code>ï¼›</li></ol><h3 id=unlink><code>unlink()</code></h3><p><code>unlink</code> å‡½æ•°ç”¨æ¥å°†åŒå‘é“¾è¡¨ä¸­çš„ä¸€ä¸ªå…ƒç´ å–å‡ºæ¥ï¼Œå®ƒæºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Take a chunk off a bin list */</span>
</span></span><span class=line><span class=cl><span class=c1>// unlink p
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define unlink(AV, P, BK, FD) {                                            \
</span></span></span><span class=line><span class=cl><span class=cp>    </span><span class=c1>// ç”±äº P å·²ç»åœ¨åŒå‘é“¾è¡¨ä¸­ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªåœ°æ–¹è®°å½•å…¶å¤§å°ï¼Œæ‰€ä»¥æ£€æŸ¥ä¸€ä¸‹å…¶å¤§å°æ˜¯å¦ä¸€è‡´ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span> <span class=p>(</span><span class=nf>chunksize</span><span class=p>(</span><span class=n>P</span><span class=p>)</span> <span class=o>!=</span> <span class=nf>prev_size</span> <span class=p>(</span><span class=nf>next_chunk</span><span class=p>(</span><span class=n>P</span><span class=p>)),</span> <span class=mi>0</span><span class=p>))</span>      \
</span></span><span class=line><span class=cl>      <span class=nf>malloc_printerr</span> <span class=p>(</span><span class=s>&#34;corrupted size vs. prev_size&#34;</span><span class=p>);</span>               \
</span></span><span class=line><span class=cl>    <span class=n>FD</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>                                                                      \
</span></span><span class=line><span class=cl>    <span class=n>BK</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>                                                                      \
</span></span><span class=line><span class=cl>    <span class=c1>// é˜²æ­¢æ”»å‡»è€…ç®€å•ç¯¡æ”¹ç©ºé—²çš„ chunk çš„ fd ä¸ bk æ¥å®ç°ä»»æ„å†™çš„æ•ˆæœã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span> <span class=p>(</span><span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>!=</span> <span class=n>P</span> <span class=o>||</span> <span class=n>BK</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>P</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>                      \
</span></span><span class=line><span class=cl>      <span class=nf>malloc_printerr</span> <span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=s>&#34;corrupted double-linked list&#34;</span><span class=p>,</span> <span class=n>P</span><span class=p>,</span> <span class=n>AV</span><span class=p>);</span>  \
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>                                                                      \
</span></span><span class=line><span class=cl>        <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>BK</span><span class=p>;</span>                                                              \
</span></span><span class=line><span class=cl>        <span class=n>BK</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span>                                                              \
</span></span><span class=line><span class=cl>        <span class=c1>// ä¸‹é¢ä¸»è¦è€ƒè™‘ P å¯¹åº”çš„ nextsize åŒå‘é“¾è¡¨çš„ä¿®æ”¹
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span> <span class=p>(</span><span class=nf>chunksize_nomask</span> <span class=p>(</span><span class=n>P</span><span class=p>))</span>                              \
</span></span><span class=line><span class=cl>            <span class=c1>// å¦‚æœP-&gt;fd_nextsizeä¸º NULLï¼Œè¡¨æ˜ P æœªæ’å…¥åˆ° nextsize é“¾è¡¨ä¸­ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// é‚£ä¹ˆå…¶å®ä¹Ÿå°±æ²¡æœ‰å¿…è¦å¯¹ nextsize å­—æ®µè¿›è¡Œä¿®æ”¹äº†ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// è¿™é‡Œæ²¡æœ‰å»åˆ¤æ–­ bk_nextsize å­—æ®µï¼Œå¯èƒ½ä¼šå‡ºé—®é¢˜ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>&amp;&amp;</span> <span class=nf>__builtin_expect</span> <span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>                      \
</span></span><span class=line><span class=cl>            <span class=c1>// ç±»ä¼¼äºå°çš„ chunk çš„æ£€æŸ¥æ€è·¯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span> <span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>!=</span> <span class=n>P</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>              \
</span></span><span class=line><span class=cl>                <span class=o>||</span> <span class=nf>__builtin_expect</span> <span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>!=</span> <span class=n>P</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>    \
</span></span><span class=line><span class=cl>              <span class=nf>malloc_printerr</span> <span class=p>(</span><span class=n>check_action</span><span class=p>,</span>                                      \
</span></span><span class=line><span class=cl>                               <span class=s>&#34;corrupted double-linked list (not small)&#34;</span><span class=p>,</span>    \
</span></span><span class=line><span class=cl>                               <span class=n>P</span><span class=p>,</span> <span class=n>AV</span><span class=p>);</span>                                              \
</span></span><span class=line><span class=cl>            <span class=c1>// è¿™é‡Œè¯´æ˜ P å·²ç»åœ¨ nextsize é“¾è¡¨ä¸­äº†ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// å¦‚æœ FD æ²¡æœ‰åœ¨ nextsize é“¾è¡¨ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>FD</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>                                      \
</span></span><span class=line><span class=cl>                <span class=c1>// å¦‚æœ nextsize ä¸²èµ·æ¥çš„åŒé“¾è¡¨åªæœ‰ P æœ¬èº«ï¼Œé‚£å°±ç›´æ¥æ‹¿èµ° P
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// ä»¤ FD ä¸º nextsize ä¸²èµ·æ¥çš„
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>==</span> <span class=n>P</span><span class=p>)</span>                                      \
</span></span><span class=line><span class=cl>                  <span class=n>FD</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span>                      \
</span></span><span class=line><span class=cl>                <span class=k>else</span> <span class=p>{</span>                                                              \
</span></span><span class=line><span class=cl>                <span class=c1>// å¦åˆ™æˆ‘ä»¬éœ€è¦å°† FD æ’å…¥åˆ° nextsize å½¢æˆçš„åŒé“¾è¡¨ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>FD</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=p>;</span>                              \
</span></span><span class=line><span class=cl>                    <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>                              \
</span></span><span class=line><span class=cl>                    <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span>                              \
</span></span><span class=line><span class=cl>                    <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span>                              \
</span></span><span class=line><span class=cl>                  <span class=p>}</span>                                                              \
</span></span><span class=line><span class=cl>              <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>                                                              \
</span></span><span class=line><span class=cl>                <span class=c1>// å¦‚æœåœ¨çš„è¯ï¼Œç›´æ¥æ‹¿èµ°å³å¯
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>                      \
</span></span><span class=line><span class=cl>                <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=p>;</span>                      \
</span></span><span class=line><span class=cl>              <span class=p>}</span>                                                                      \
</span></span><span class=line><span class=cl>          <span class=p>}</span>                                                                      \
</span></span><span class=line><span class=cl>      <span class=p>}</span>                                                                              \
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ƒå¯èƒ½åœ¨ä»¥ä¸‹å‡½æ•°ä¸­è¢«è°ƒç”¨ï¼š</p><ul><li><p><code>malloc</code>ï¼š</p><ul><li><p>ä»æ°å¥½å¤§å°åˆé€‚çš„ large bin ä¸­è·å– chunkã€‚</p><ul><li><p><strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>fastbin</code> ä¸ <code>small bin</code> å°±æ²¡æœ‰ä½¿ç”¨ <code>unlink</code></strong></p></li><li><p>ä¾æ¬¡éå†å¤„ç† unsorted bin æ—¶ä¹Ÿæ²¡æœ‰ä½¿ç”¨ unlink çš„ã€‚</p></li></ul></li><li><p>ä»æ¯”è¯·æ±‚çš„ chunk æ‰€åœ¨çš„ bin å¤§çš„ bin ä¸­å– chunkã€‚</p></li></ul></li><li><p><code>free</code>ï¼š</p><ul><li>åå‘åˆå¹¶ï¼Œåˆå¹¶ç‰©ç†ç›¸é‚»ä½åœ°å€ç©ºé—² chunkã€‚</li><li>å‰å‘åˆå¹¶ï¼Œåˆå¹¶ç‰©ç†ç›¸é‚»é«˜åœ°å€ç©ºé—² chunkï¼ˆé™¤äº† top chunkï¼‰ã€‚</li></ul></li><li><p><code>malloc_consolidate</code>ï¼š</p><ul><li>åå‘åˆå¹¶ï¼Œåˆå¹¶ç‰©ç†ç›¸é‚»ä½åœ°å€ç©ºé—² chunkã€‚</li><li>å‰å‘åˆå¹¶ï¼Œåˆå¹¶ç‰©ç†ç›¸é‚»é«˜åœ°å€ç©ºé—² chunkï¼ˆé™¤äº† top chunkï¼‰ã€‚</li></ul></li><li><p><code>realloc</code>ï¼š</p><ul><li>å‰å‘æ‰©å±•ï¼Œåˆå¹¶ç‰©ç†ç›¸é‚»é«˜åœ°å€ç©ºé—² chunkï¼ˆé™¤äº† top chunkï¼‰ã€‚</li></ul></li></ul><h2 id=å¤šçº¿ç¨‹ä¼˜åŒ–æ‰‹æ®µ-tcache>å¤šçº¿ç¨‹ä¼˜åŒ–æ‰‹æ®µ <code>tcache</code></h2><h3 id=ç®€ä»‹>ç®€ä»‹</h3><p><code>tcache</code>ï¼Œå…¨ç§°æ˜¯ <code>thread local caching</code>ï¼Œæ˜¯ <code>libc 2.26</code> ç‰ˆæœ¬ä¸­æ–°å¢åŠ çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå±äºä¸€ç§ç”¨äºåŠ é€Ÿ <code>malloc</code> åˆ†é…çš„ç¼“å­˜æœºåˆ¶ã€‚</p><p>å®ƒç”± 64 ä¸ªé“¾è¡¨ç»„æˆï¼Œå¤„ç†é€»è¾‘ä½äº <code>malloc</code> å‡½æ•°å’Œ <code>free</code> å‡½æ•°ä¸­ï¼Œä¼˜å…ˆçº§è¾ƒé«˜ï¼Œä¼šå…ˆäºå…¨éƒ¨çš„ <code>bin</code> æ¥å¤„ç†ï¼Œå½“ç¼“å­˜é“¾è¡¨è£…æ»¡æ—¶ï¼Œåˆ†é…æ–¹å¼å°±ä¸ä¹‹å‰ç‰ˆæœ¬çš„ <code>malloc</code> ç›¸åŒã€‚</p><h3 id=tcache_entry--tcache_perthread_struct><code>tcache_entry</code> && <code>tcache_perthread_struct</code></h3><p>åœ¨ <code>tcache</code> ä¸­æ–°å¢äº†ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒä»¬çš„å®šä¹‰æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* We overlay this structure on the user-data portion of a chunk when
</span></span></span><span class=line><span class=cl><span class=cm>   the chunk is stored in the per-thread cache.  */</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>tcache_entry</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* This field exists to detect double frees.  */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>tcache_perthread_struct</span> <span class=o>*</span><span class=n>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>tcache_entry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* There is one of these for each thread, which contains the
</span></span></span><span class=line><span class=cl><span class=cm>   per-thread cache (hence &#34;tcache_perthread_struct&#34;).  Keeping
</span></span></span><span class=line><span class=cl><span class=cm>   overall size low is mildly important.  Note that COUNTS and ENTRIES
</span></span></span><span class=line><span class=cl><span class=cm>   are redundant (we could have just counted the linked list each
</span></span></span><span class=line><span class=cl><span class=cm>   time), this is for performance reasons.  */</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>tcache_perthread_struct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint16_t</span> <span class=n>counts</span><span class=p>[</span><span class=n>TCACHE_MAX_BINS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>entries</span><span class=p>[</span><span class=n>TCACHE_MAX_BINS</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>tcache_perthread_struct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__thread</span> <span class=kt>bool</span> <span class=n>tcache_shutting_down</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__thread</span> <span class=n>tcache_perthread_struct</span> <span class=o>*</span><span class=n>tcache</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯è§æºç ä¸­ç›´æ¥å®šä¹‰äº†ä¸€ä¸ªåè€…çš„ä¸€ä¸ªå¯¹è±¡ <code>tcache</code>ï¼Œå‡è®¾å‰è€…æœ‰ä¸¤ä¸ªåƒåœ¾å¯¹è±¡ï¼Œå…¶å†…å­˜å¸ƒå±€å¤§è‡´å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>                                                                                       
</span></span><span class=line><span class=cl>     tcache_perthread_struct *tcache                                                   
</span></span><span class=line><span class=cl>                               |                                                       
</span></span><span class=line><span class=cl>                               |                                                       
</span></span><span class=line><span class=cl>                               v                                                       
</span></span><span class=line><span class=cl>      +---------------------------+---+                                                
</span></span><span class=line><span class=cl> 2*64 |    uint16_t counts[64]    | 0 |&lt;----------------------------------------------+
</span></span><span class=line><span class=cl>      +--------------------------------                                               |
</span></span><span class=line><span class=cl>                                  | 2 |                                               |
</span></span><span class=line><span class=cl>                                  -----                                               |
</span></span><span class=line><span class=cl>                                  |...|                                               |
</span></span><span class=line><span class=cl>                                  -----                                               |
</span></span><span class=line><span class=cl>                                  | 0 |                                               |
</span></span><span class=line><span class=cl>                                  -----                                               |
</span></span><span class=line><span class=cl>                                  | 0 |                                               |
</span></span><span class=line><span class=cl>      +---------------------------+------+                                            |
</span></span><span class=line><span class=cl> 4*64 | tcache_entry *entries[64] | null |                                            |
</span></span><span class=line><span class=cl>      +-----------------------------------     +------------------------------+       |
</span></span><span class=line><span class=cl>                                  | ptr  |----&gt;|      tcache_entry *next      |-+     |
</span></span><span class=line><span class=cl>                                  --------     -------------------------------- |     |
</span></span><span class=line><span class=cl>                                  | ...  |     | tcache_perthread_struct *key |-|-----+
</span></span><span class=line><span class=cl>                                  --------     +------------------------------+ |     |
</span></span><span class=line><span class=cl>                                  | null |  +-----------------------------------+     |
</span></span><span class=line><span class=cl>                                  --------  |  +------------------------------+       |
</span></span><span class=line><span class=cl>                                  | null |  +-&gt;|      tcache_entry *next      |-&gt;null |
</span></span><span class=line><span class=cl>                                  +------+     --------------------------------       |
</span></span><span class=line><span class=cl>                                               | tcache_perthread_struct *key |-------+
</span></span><span class=line><span class=cl>                                               +------------------------------+        
</span></span></code></pre></td></tr></table></div></div><h3 id=tcache_get--tcache_put><code>tcache_get</code> && <code>tcache_put</code></h3><p>ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œ<code>tcache_get()</code> ä¸ <code>tcache_put()</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Caller must ensure that we know tc_idx is valid and there&#39;s room
</span></span></span><span class=line><span class=cl><span class=cm>   for more chunks.  */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>tcache_put</span> <span class=p>(</span><span class=n>mchunkptr</span> <span class=n>chunk</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>tc_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_entry</span> <span class=o>*</span><span class=p>)</span> <span class=nf>chunk2mem</span> <span class=p>(</span><span class=n>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Mark this chunk as &#34;in the tcache&#34; so the test in _int_free will
</span></span></span><span class=line><span class=cl><span class=cm>     detect a double free.  */</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>key</span> <span class=o>=</span> <span class=n>tcache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>++</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Caller must ensure that we know tc_idx is valid and there&#39;s
</span></span></span><span class=line><span class=cl><span class=cm>   available chunks to remove.  */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>tcache_get</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>tc_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>--</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>key</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>å‰è€…å°†ä¸€ä¸ªå…ƒç´ æ’å…¥äº†å•å‘é“¾è¡¨çš„å¤´éƒ¨ï¼Œå¹¶ä¸”å°†å¯¹åº”ä½ç½®çš„ <code>counts</code> å¤§å°è‡ªå¢ä¸€ï¼›</li><li>åè€…å•å‘é“¾è¡¨å¤´éƒ¨èŠ‚ç‚¹å–å‡ºå¹¶è¿”å›ï¼Œå¹¶ä¸”å°†å¯¹åº”ä½ç½®çš„ <code>counts</code> å¤§å°è‡ªå‡ä¸€ã€‚</li></ul><h3 id=_int_free><code>_int_free</code></h3><p>åœ¨å†…å­˜é‡Šæ”¾çš„ <code>free</code> å‡½æ•°ä¸­ï¼Œå¯¹ <code>tcache</code> çš„ç›¸å…³è°ƒç”¨åªæœ‰ä»¥ä¸‹çš„ä¸€å¤„ï¼Œè¯¥å¤„åœ¨å‡½æ•°çš„æœ€å¼€å§‹æ‰§è¡Œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span> <span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=o>&amp;&amp;</span> <span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* Check to see if it&#39;s already in the tcache.  */</span>
</span></span><span class=line><span class=cl>	<span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_entry</span> <span class=o>*</span><span class=p>)</span> <span class=nf>chunk2mem</span> <span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* This test succeeds on double free.  However, we don&#39;t 100%
</span></span></span><span class=line><span class=cl><span class=cm>	   trust it (it also matches random payload data at a 1 in
</span></span></span><span class=line><span class=cl><span class=cm>	   2^&lt;size_t&gt; chance), so verify it&#39;s not an unlikely
</span></span></span><span class=line><span class=cl><span class=cm>	   coincidence before aborting.  */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>key</span> <span class=o>==</span> <span class=n>tcache</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	  <span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_tcache_double_free</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	    <span class=k>for</span> <span class=p>(</span><span class=n>tmp</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		 <span class=n>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		 <span class=n>tmp</span> <span class=o>=</span> <span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	      <span class=k>if</span> <span class=p>(</span><span class=n>tmp</span> <span class=o>==</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>malloc_printerr</span> <span class=p>(</span><span class=s>&#34;free(): double free detected in tcache 2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	    <span class=cm>/* If we get here, it was a coincidence.  We&#39;ve wasted a
</span></span></span><span class=line><span class=cl><span class=cm>	       few cycles, but don&#39;t abort.  */</span>
</span></span><span class=line><span class=cl>	  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	  <span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=nf>tcache_put</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></td></tr></table></div></div><p>å¯è§ï¼Œåœ¨æ‰§è¡Œ <code>tcache_put</code> æ“ä½œä¹‹å‰ï¼Œå‡½æ•°ä¸»è¦è¿›è¡Œäº†ä¸‰ä¸ªæ£€æµ‹ï¼š</p><ol><li>å½“å‰çš„ <code>tcache</code> å­˜åœ¨ï¼Œå¹¶ä¸”ç›®æ ‡å—çš„å¤§å°åœ¨èŒƒå›´å†…ï¼›</li><li>ç›®æ ‡å—çš„ <code>key</code> æ˜¯å¦æŒ‡å‘äº† <code>tcache</code>ï¼Œè‹¥å·²ç»æŒ‡å‘äº†ç›®æ ‡åœ°å€ï¼Œåˆ™æœ‰å¯èƒ½æ˜¯ <code>Double Free</code>ï¼›</li><li>ç›®æ ‡çš„åƒåœ¾ç®±é“¾è¡¨é•¿åº¦æ˜¯å¦å·²ç»è¾¾åˆ°ä¸Šé™ï¼ˆæºç ä¸­å°†ä¸Šé™å®šä¹‰ä¸º 7ï¼‰ã€‚</li></ol><h3 id=_int_malloc><code>_int_malloc</code></h3><p>è€Œåœ¨å†…å­˜åˆ†é…çš„ <code>malloc</code> å‡½æ•°ä¸­ï¼Œå¯¹ <code>tcache</code> çš„è°ƒç”¨æœ‰äº”å¤„ï¼Œæ ¹æ® <code>ctf-wiki</code> ä¸­çš„ä»‹ç»ï¼Œä¸»è¦æœ‰ä»¥ä¸‹çš„å‡ ç‚¹ï¼š</p><ol><li><p>é¦–å…ˆï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ <code>fastbin</code> å¤§å°æ—¶å¹¶ä¸”æ‰¾åˆ°åœ¨ <code>fastbin</code> å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥ <code>fastbin</code> é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥ <code>tcache</code> ä¸­ã€‚</p></li><li><p>å…¶æ¬¡ï¼Œç”³è¯·çš„å†…å­˜å—ç¬¦åˆ <code>smallbin</code> å¤§å°æ—¶å¹¶ä¸”æ‰¾åˆ°åœ¨ <code>smallbin</code> å†…æ‰¾åˆ°å¯ç”¨çš„ç©ºé—²å—æ—¶ï¼Œä¼šæŠŠè¯¥ <code>smallbin</code> é“¾ä¸Šçš„å…¶ä»–å†…å­˜å—æ”¾å…¥ <code>tcache</code> ä¸­ã€‚</p></li><li><p>å½“åœ¨ <code>unsorted bin</code> é“¾ä¸Šå¾ªç¯å¤„ç†æ—¶ï¼Œå½“æ‰¾åˆ°å¤§å°åˆé€‚çš„é“¾æ—¶ï¼Œå¹¶ä¸ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯å…ˆæ”¾åˆ° <code>tcache</code> ä¸­ï¼Œç»§ç»­å¤„ç†ã€‚</p></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2019-08-02</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=http://shesl-meow.github.io/posts/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/ data-title=:truck:å †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é… data-hashtags=Linux,æœåŠ¡ç«¯,ä¿¡æ¯å®‰å…¨,C++><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Facebook" data-sharer=facebook data-url=http://shesl-meow.github.io/posts/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/ data-hashtag=Linux><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=http://shesl-meow.github.io/posts/%E5%A0%86%E5%8C%BA%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/ data-title=:truck:å †åŒºå¦‚ä½•è¿›è¡Œå†…å­˜åˆ†é… data-ralateuid=3968720593><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF/>æœåŠ¡ç«¯</a>,&nbsp;<a href=/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/>ä¿¡æ¯å®‰å…¨</a>,&nbsp;<a href=/tags/c++/>C++</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/posts/%E6%A6%82%E5%BF%B5%E5%AD%A6%E4%B9%A0%E4%B8%8E%E9%9D%A2%E8%AF%95%E9%A2%98/ class=prev rel=prev title=:ambulance:æ¦‚å¿µå­¦ä¹ ä¸é¢è¯•é¢˜><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>ğŸš‘æ¦‚å¿µå­¦ä¹ ä¸é¢è¯•é¢˜</a>
<a href=/posts/elf%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90%E6%8C%87%E5%8C%97/ class=next rel=next title=:moyai:Elfæ–‡ä»¶åˆ†ææŒ‡åŒ—>ğŸ—¿Elfæ–‡ä»¶åˆ†ææŒ‡åŒ—<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shesl-meow.github.io target=_blank>ä½˜å´§æ—</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.8127f0ca4cabc7246f3620f3ef3bf9b1db02805dfe03d6d4c57bc74bc0bf6eea.js integrity="sha256-gSfwykyrxyRvNiDz7zv5sdsCgF3+A9bUxXvHS8C/buo="></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.825fab54c26891370cbd3df4cdff5c9de31af8bb84474e6774573463d8708ae7.js integrity="sha256-gl+rVMJokTcMvT30zf9cneMa+LuER05ndFc0Y9hwiuc="></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:50},comment:{valine:{appId:"zDVJohJIQbD6f3W267xtaYRC-gzGzoHsz",appKey:"ewsfU9ocNOeuvt0MzONe6yKx",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"ä½ çš„è¯„è®º ...",recordIP:!0,serverURLs:"https://zdvjohji.lc-cn-n1-shared.com",visitor:!0}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.d7121d72cd85153ec9d35a888cee3eb28c2700ca763f649a538f6c772d750021.js integrity="sha256-1xIdcs2FFT7J01qIjO4+sownAMp2P2SaU49sdy11ACE="></script></body></html>